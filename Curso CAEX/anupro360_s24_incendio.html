<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Anupro360 · Sección 2.4 · Amago de Incendio o Incendio · Operador de Camión de Extracción</title>
  <meta name="description" content="Aplicación web didáctica 100% texto: protocolo ante amago de incendio o incendio en equipos. Incluye 5 juegos interactivos con retroalimentación y un quiz de 20 preguntas. Sin imágenes."/>
  <style>
    :root{
      --amarillo:#FFB81C; --naranja:#FF5C00; --gris:#5C6B6B; --verde:#4B6F44; --azul:#003B5C; --blanco:#FFFFFF;
      --ok:#00C853; --bad:#FF1744;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; background:linear-gradient(180deg,var(--azul) 0%, #072A3D 100%); color:var(--blanco); -webkit-font-smoothing:antialiased}
    p, li{ text-align: justify; }
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px); background:rgba(0,59,92,.85); border-bottom:1px solid rgba(255,255,255,.12)}
    .wrap{max-width:1080px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:10px}
    h1{font-size:1.02rem; margin:0}
    .chip{font-size:.75rem; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15); padding:4px 8px; border-radius:999px}
    .hero{border-bottom:1px solid rgba(255,255,255,.08); background: radial-gradient(900px 220px at 50% -40%, rgba(255,184,28,.25), transparent), radial-gradient(800px 280px at 100% 0%, rgba(255,92,0,.15), transparent)}
    .hero h2{margin:.25rem 0 .5rem; font-size:1.25rem}
    .note{font-size:.92rem; opacity:.95}
    .progress{height:10px; width:100%; border-radius:999px; background:rgba(255,255,255,.15); overflow:hidden}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--amarillo),var(--naranja)); transition:width .4s ease}
    .grid{display:grid; gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h3{margin-top:0}
    .btn,.btn-ghost,.btn-sec{cursor:pointer; border:none; border-radius:12px; padding:10px 14px; font-weight:600}
    .btn{background:linear-gradient(180deg,var(--amarillo),#EAA20F); color:#0b1116; box-shadow:0 6px 16px rgba(255,184,28,.35)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent; color:var(--blanco); border:1px solid rgba(255,255,255,.25); text-decoration:none; display:inline-block}
    .btn-sec{background:linear-gradient(180deg,var(--verde),#375636); color:#fff}
    details{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px}
    details>summary{cursor:pointer; font-weight:700}
    table{width:100%; border-collapse:collapse; border:1px solid rgba(255,255,255,.18); margin-top:8px}
    th,td{border:1px solid rgba(255,255,255,.18); padding:8px; text-align:left}
    thead th{text-align:center}
    .q{padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.045); margin-bottom:10px}
    .q.correct{border-color: var(--ok); background: rgba(0,200,83,.12)}
    .q.wrong{border-color: var(--bad); background: rgba(255,23,68,.12)}
    .opt{display:flex; gap:8px; align-items:flex-start; margin:6px 0}
    .opt.correct{outline:2px solid var(--ok); border-radius:8px; padding:4px}
    .opt.wrong{outline:2px solid var(--bad); border-radius:8px; padding:4px}
    .sortable{list-style:none; padding:0; margin:0}
    .sortable li{background:rgba(255,255,255,.06); border:1px dashed rgba(255,255,255,.3); padding:10px; border-radius:10px; margin:6px 0; cursor:grab}
    .sortable li.dragging{opacity:.6}
    .dropzone{border:2px dashed rgba(255,255,255,.35); border-radius:12px; padding:6px}
    .zones{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .zone{border:2px dashed rgba(255,255,255,.35); border-radius:12px; padding:8px; min-height:120px}
    .tag{display:inline-block; margin:6px; padding:8px 10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.25); border-radius:10px; cursor:grab}
    .dragging{opacity:.6}
    footer{opacity:.8; font-size:.85rem; padding:24px 0}
    .chip2{font-size:.72rem; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08)}
    .timer{font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25)}
  </style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
    <div class="brand">
      <h1>Anupro360 · Sección 2.4 · Amago de Incendio o Incendio</h1>
    </div>
    <div class="chip" id="badge">Progreso 0%</div>
  </div>
</header>

<section class="hero">
  <div class="wrap">
    <h2>Actuación Segura ante Amago de Incendio o Incendio</h2>
    <p class="note"><strong>Aprenderás a:</strong> detener el equipo, comunicar por radio y activar <em>botón rojo (TRACKING)</em>, usar <em>DISPATCH</em> si no hay radio, estacionar y aplicar <em>freno</em>, detener <em>motor</em> y desactivar <em>interruptor general</em>, percutar <em>AFEX</em> si el fuego es en motor, usar extintor solo si no es motor ni neumáticos, evacuar si se descontrola, solicitar brigadas de emergencia, aislar 250 m si hay neumáticos comprometidos y restringir accesos según el supervisor.</p>
    <div class="progress" aria-label="Progreso del módulo"><i id="bar"></i></div>
  </div>
</section>

<main class="wrap grid" id="app" role="main">
  <!-- CONTENIDO DIDÁCTICO AMPLIADO -->
  <section class="card">
    <h3>1) Detección y comunicación inmediata (operador)</h3>
    <ul>
      <li><strong>Detén el equipo de inmediato</strong> al percatarte del amago/incendio.</li>
      <li><strong>Avisa por radio</strong> activando el <strong>botón rojo (TRACKING)</strong>.</li>
      <li><strong>Comunica datos críticos</strong>: nombre, ubicación exacta, equipo, tipo de emergencia, personas involucradas y requerimientos de ayuda.</li>
      <li>Si no hay radio, <strong>activa emergencia por DISPATCH</strong> y, si es posible, <strong>envía un mensaje escrito</strong> por la pantalla.</li>
    </ul>
    <details>
      <summary>Plantilla de mensaje radial</summary>
      <p><em>“Supervisor/Control, de Camión 123: amago/incendio en frente sur, punto X/Y. Botón rojo TRACKING activado. Opero Camión 793, 1 persona a bordo, solicito apoyo y brigada si es necesario. Cambio.”</em></p>
    </details>
    <div class="flex"><button class="btn" data-complete="comunicacion">Marcar leído ✓</button></div>
  </section>

  <section class="card">
    <h3>2) Parada segura y corte de energía</h3>
    <ul>
      <li><strong>Estaciona el equipo</strong> en lugar seguro.</li>
      <li><strong>Aplica freno de estacionamiento</strong>.</li>
      <li><strong>Detén el motor</strong>.</li>
      <li><strong>Desactiva el interruptor general</strong>.</li>
    </ul>
    <details>
      <summary>Checklist 20 segundos</summary>
      <ol>
        <li>Estacionar en zona despejada.</li>
        <li>Freno de estacionamiento.</li>
        <li>Motor detenido.</li>
        <li>Interruptor general desactivado.</li>
      </ol>
    </details>
    <div class="flex"><button class="btn" data-complete="parada">Marcar leído ✓</button></div>
  </section>

  <section class="card">
    <h3>3) Control inicial del fuego</h3>
    <ul>
      <li><strong>Incendio en motor:</strong> <u>percuta el sistema AFEX</u> (cabina, a la derecha del operador).</li>
      <li><strong>Fuego que no sea en motor ni neumáticos:</strong> utilice <strong>extintor</strong> y trate de sofocarlo.</li>
      <li>Si el fuego <strong>se descontrola</strong>, <strong>evacúe inmediatamente</strong> el camión.</li>
      <li>Si el fuego <strong>aumenta y no logra control primario</strong>, el <strong>supervisor</strong> debe recurrir a <strong>brigadas de emergencia</strong>, quienes <u>toman el control total</u>.</li>
    </ul>
    <details>
      <summary>Notas de seguridad</summary>
      <p>Decidir rápidamente entre AFEX/extintor según ubicación del fuego. Priorizar la vida sobre el equipo. Mantener comunicaciones con supervisor/brigada.</p>
    </details>
    <div class="flex"><button class="btn" data-complete="control">Marcar leído ✓</button></div>
  </section>

  <section class="card">
    <h3>4) Protocolo especial: fuego en neumáticos</h3>
    <ul>
      <li>Al abandonar el equipo, hacerlo por el <strong>costado opuesto</strong> al neumático que se incendia.</li>
      <li>El <strong>supervisor</strong> debe <strong>aislar el sector en un radio de 250 metros</strong>, usando <strong>cierres físicos</strong>.</li>
      <li>Es <u>prohibido</u> acercarse al neumático afectado o intentar apagarlo con <strong>extintor portátil o mangueras</strong>.</li>
      <li>La única forma de apagar este fuego es <strong>agua</strong> con los <strong>sistemas de camiones aljibes</strong>.</li>
      <li>El supervisor actúa según el <strong>procedimiento general de emergencias de producción mina</strong>.</li>
    </ul>
    <details>
      <summary>Justificación técnica</summary>
      <p>El neumático incendiado puede explotar o proyectar fragmentos. El enfriamiento seguro requiere grandes volúmenes de agua controlada por equipos especializados (aljibes/brigada).</p>
    </details>
    <div class="flex"><button class="btn" data-complete="neumaticos">Marcar leído ✓</button></div>
  </section>

  <!-- JUEGOS (5) -->
  <section class="card" id="juego1">
    <h3>5) Juego 1 · Ordena las acciones del primer minuto</h3>
    <p>Arrastra para ordenar los pasos críticos.</p>
    <ul class="sortable dropzone" id="ordenar"></ul>
    <div class="flex" style="margin-top:8px">
      <button class="btn-sec" id="checkOrden">Evaluar</button>
      <span id="fbOrden" class="chip2" aria-live="polite"></span>
      <button class="btn-ghost" id="regenOrden">Mezclar</button>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="juego1">Marcar juego 1 ✓</button></div>
  </section>

  <section class="card" id="juego2">
    <h3>6) Juego 2 · ¿Correcto o Prohibido?</h3>
    <p>Clasifica cada tarjeta: <strong>Correcto</strong> o <strong>Prohibido</strong>. Feedback verde/rojo inmediato.</p>
    <div class="zones">
      <div>
        <h4>Correcto</h4>
        <div id="zoneOK" class="zone" aria-label="Zona Correcto"></div>
      </div>
      <div>
        <h4>Prohibido</h4>
        <div id="zoneBAD" class="zone" aria-label="Zona Prohibido"></div>
      </div>
    </div>
    <div id="pool" style="margin-top:10px"></div>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn-sec" id="checkClasif">Evaluar</button>
      <button class="btn-ghost" id="resetClasif">Reiniciar</button>
      <span id="fbClasif" class="chip2" aria-live="polite"></span>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="juego2">Marcar juego 2 ✓</button></div>
  </section>

  <section class="card" id="juego3">
    <h3>7) Juego 3 · Completa la frase (arrastrar a huecos)</h3>
    <p>Arrastra los términos correctos a los espacios subrayados.</p>
    <p id="fillSentence" style="line-height:1.9"></p>
    <div id="fillPool" style="margin-top:8px"></div>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn-sec" id="checkFill">Evaluar</button>
      <button class="btn-ghost" id="resetFill">Reiniciar</button>
      <span id="fbFill" class="chip2" aria-live="polite"></span>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="juego3">Marcar juego 3 ✓</button></div>
  </section>

  <section class="card" id="juego4">
    <h3>8) Juego 4 · Relaciona roles con responsabilidades</h3>
    <p>Arrastra cada tarjeta al rol que corresponde.</p>
    <div class="zones" style="grid-template-columns:1fr 1fr">
      <div>
        <h4>Operador</h4>
        <div id="role_operador" class="zone"></div>
      </div>
      <div>
        <h4>Supervisor</h4>
        <div id="role_supervisor" class="zone"></div>
      </div>
      <div>
        <h4>Brigada Emergencia</h4>
        <div id="role_brigada" class="zone"></div>
      </div>
      <div>
        <h4>Camiones Aljibes</h4>
        <div id="role_aljibes" class="zone"></div>
      </div>
      <div>
        <h4>Despacho/Control</h4>
        <div id="role_despacho" class="zone"></div>
      </div>
    </div>
    <div id="rolesPool" style="margin-top:10px"></div>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn-sec" id="checkRoles">Evaluar</button>
      <button class="btn-ghost" id="resetRoles">Reiniciar</button>
      <span id="fbRoles" class="chip2" aria-live="polite"></span>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="juego4">Marcar juego 4 ✓</button></div>
  </section>

  <section class="card" id="juego5">
    <h3>9) Juego 5 · Decisiones en 10 segundos</h3>
    <p>Lee el escenario y elige <strong>la mejor acción</strong> antes de que el tiempo llegue a 0.</p>
    <div class="timer" id="timer">Tiempo: 10</div>
    <div id="timedQuestion" style="margin-top:8px"></div>
    <div id="timedOpts" style="margin-top:8px"></div>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn-sec" id="nextTimed">Siguiente</button>
      <span id="fbTimed" class="chip2" aria-live="polite"></span>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="juego5">Marcar juego 5 ✓</button></div>
  </section>

  <!-- QUIZ 20 PREGUNTAS -->
  <section class="card">
    <h3>10) Quiz final (20 preguntas)</h3>
    <div id="quiz"></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn-sec" id="enviar">Enviar respuestas</button>
      <button class="btn-ghost" id="resetQuiz">Reiniciar quiz</button>
    </div>
    <div id="quizFeedback" class="note" aria-live="polite" style="margin-top:8px"></div>
    <button class="btn" data-complete="quiz" style="margin-top:8px">Marcar quiz completado ✓</button>
  </section>

  <!-- REFLEXIÓN -->
  <section class="card">
    <h3>11) Reflexión final</h3>
    <textarea id="reflexion" rows="3" placeholder="En 2-3 líneas: ¿por qué es peligroso intentar apagar un neumático con extintor?"></textarea>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
      <button class="btn-ghost" id="guardarRef">Guardar</button>
      <button class="btn-ghost" id="copiarRef">Copiar para Classroom</button>
    </div>
    <p class="note">Se guarda sólo en este dispositivo.</p>
  </section>
</main>

<footer class="wrap">
  <div>© <span id="year"></span> Anupro360</div>
</footer>

<script>
  /* Utilidades */
  const $ = (s,d=document)=>d.querySelector(s);
  const $$ = (s,d=document)=>Array.from(d.querySelectorAll(s));
  const store = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const read  = (k,def=null)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? def}catch(e){return def} };

  const state = read('anupro360_s24_incendio', {
    done:{comunicacion:false,parada:false,control:false,neumaticos:false,juego1:false,juego2:false,juego3:false,juego4:false,juego5:false,quiz:false},
    reflexion:''
  });

  function calcProgress(){
    const total = Object.values(state.done).length;
    const ok = Object.values(state.done).filter(Boolean).length;
    const pct = Math.round(ok/total*100);
    $('#bar').style.width = pct+'%';
    $('#badge').textContent = `Progreso ${pct}%`;
  }
  $$('button[data-complete]').forEach(b=>{
    b.addEventListener('click', e=>{
      const key = e.currentTarget.dataset.complete;
      state.done[key] = true; store('anupro360_s24_incendio', state); calcProgress();
      e.currentTarget.textContent='Completado ✓'; e.currentTarget.disabled=true; e.currentTarget.classList.add('btn-ghost');
    })
  });

  /* ----------------- Juego 1: Ordenar pasos (primer minuto) ----------------- */
  const pasosPrimerMinuto = [
    'Detener de inmediato el equipo',
    'Avisar por radio y activar botón rojo TRACKING',
    'Entregar nombre, ubicación, equipo, tipo de emergencia, personas y ayuda requerida',
    'Si no hay radio: activar DISPATCH y enviar mensaje escrito',
    'Estacionar, aplicar freno, detener motor y desactivar interruptor general'
  ];
  function renderOrdenar(){
    const ul = $('#ordenar'); ul.innerHTML='';
    const mix = pasosPrimerMinuto.slice().sort(()=>Math.random()-0.5);
    mix.forEach(txt=>{
      const li=document.createElement('li'); li.draggable=true; li.textContent=txt;
      li.addEventListener('dragstart', ()=> li.classList.add('dragging'));
      li.addEventListener('dragend',   ()=> li.classList.remove('dragging'));
      ul.appendChild(li);
    });
    // arrastre estable (no once)
    ul.ondragover = (e)=>{
      e.preventDefault();
      const dragging = ul.querySelector('.dragging');
      if(!dragging) return;
      const afterEl = getDragAfterElement(ul, e.clientY);
      if(afterEl==null){ ul.appendChild(dragging); }
      else { ul.insertBefore(dragging, afterEl); }
    };
  }
  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('li:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if(offset < 0 && offset > closest.offset){ return {offset, element: child}; }
      else { return closest; }
    }, {offset: Number.NEGATIVE_INFINITY}).element || null;
  }
  function checkOrden(){
    const lis = $$('#ordenar li');
    const actual = lis.map(li=>li.textContent.trim());
    const ok = actual.every((t,i)=> t===pasosPrimerMinuto[i]);
    const fb = $('#fbOrden');
    if(ok){ fb.textContent='¡Correcto! Orden seguro aplicado.'; fb.style.color='var(--ok)'; }
    else{ fb.textContent='Aún no. Revisa el orden: detener → radio/botón → datos → DISPATCH (si aplica) → estacionar/freno/motor/interruptor.'; fb.style.color='var(--bad)'; }
  }

  /* ----------------- Juego 2: Clasificación Correcto/Prohibido ----------------- */
  const itemsClasif = [
    {txt:'Percutar AFEX ante incendio en el motor.', tipo:'OK'},
    {txt:'Usar extintor cuando el fuego no es en motor ni neumáticos.', tipo:'OK'},
    {txt:'Evacuar si el fuego se descontrola.', tipo:'OK'},
    {txt:'Recurrir a brigadas de emergencia si el fuego aumenta y no se controla.', tipo:'OK'},
    {txt:'Abandonar por el costado opuesto al neumático en llamas.', tipo:'OK'},
    {txt:'Acercarse al neumático para evaluar temperatura.', tipo:'BAD'},
    {txt:'Intentar apagar el neumático con extintor portátil.', tipo:'BAD'},
    {txt:'Aislar 250 metros con cierres físicos.', tipo:'OK'},
    {txt:'Permitir acceso libre de personas y equipos al sector.', tipo:'BAD'},
    {txt:'Usar camiones aljibes para apagar fuego en neumáticos.', tipo:'OK'}
  ];
  function renderClasif(){
    const pool = $('#pool'); pool.innerHTML='';
    const shuffled = itemsClasif.slice().sort(()=>Math.random()-0.5);
    shuffled.forEach((it)=>{
      const tag = document.createElement('span'); tag.className='tag'; tag.textContent=it.txt; tag.draggable=true; tag.dataset.tipo=it.tipo;
      tag.addEventListener('dragstart', ()=> tag.classList.add('dragging'));
      tag.addEventListener('dragend', ()=> tag.classList.remove('dragging'));
      pool.appendChild(tag);
    });
    ['zoneOK','zoneBAD','pool'].forEach(id=>{
      const z = document.getElementById(id);
      z.ondragover = (e)=>{ e.preventDefault(); };
      z.ondrop = (e)=>{
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        if(dragging){ z.appendChild(dragging); dragging.classList.remove('dragging'); }
      };
    });
  }
  function checkClasif(){
    let ok=0, total=itemsClasif.length;
    const zOK = $('#zoneOK'); const zBAD = $('#zoneBAD');
    [...zOK.querySelectorAll('.tag')].forEach(t=>{ if(t.dataset.tipo==='OK'){ ok++; t.style.outline=`2px solid var(--ok)`; } else { t.style.outline=`2px solid var(--bad)`; }});
    [...zBAD.querySelectorAll('.tag')].forEach(t=>{ if(t.dataset.tipo==='BAD'){ ok++; t.style.outline=`2px solid var(--ok)`; } else { t.style.outline=`2px solid var(--bad)`; }});
    const fb=$('#fbClasif'); const pct=Math.round(ok/total*100);
    fb.textContent = `Resultado: ${ok}/${total} (${pct}%).`;
    fb.style.color = ok===total? 'var(--ok)':'var(--bad)';
  }
  function resetClasif(){ $('#zoneOK').innerHTML=''; $('#zoneBAD').innerHTML=''; renderClasif(); $('#fbClasif').textContent=''; }

  /* ----------------- Juego 3: Fill-in-the-blanks ----------------- */
  const fillTargets = [
    {slot:'[1]', word:'TRACKING'},
    {slot:'[2]', word:'DISPATCH'},
    {slot:'[3]', word:'AFEX'},
    {slot:'[4]', word:'interruptor general'},
    {slot:'[5]', word:'250 metros'},
    {slot:'[6]', word:'camiones aljibes'},
    {slot:'[7]', word:'costado opuesto'}
  ];
  const fillTextTemplate = 'Ante amago/incendio, activa el botón rojo de <u data-slot="[1]" class="dropSlot">[1]</u> y comunica por radio; si no hay radio, usa <u data-slot="[2]" class="dropSlot">[2]</u>. Estaciona, freno, motor detenido y <u data-slot="[4]" class="dropSlot">[4]</u> desactivado. Si el fuego es en motor, percuta <u data-slot="[3]" class="dropSlot">[3]</u>. Para fuego en neumáticos, evacúa por el <u data-slot="[7]" class="dropSlot">[7]</u>, aísla <u data-slot="[5]" class="dropSlot">[5]</u> y sólo usa <u data-slot="[6]" class="dropSlot">[6]</u> para apagar.';
  function renderFill(){
    $('#fillSentence').innerHTML = fillTextTemplate;
    const pool = $('#fillPool'); pool.innerHTML='';
    fillTargets.slice().sort(()=>Math.random()-0.5).forEach(({word})=>{
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent=word; tag.draggable=true;
      tag.addEventListener('dragstart', ()=> tag.classList.add('dragging'));
      tag.addEventListener('dragend', ()=> tag.classList.remove('dragging'));
      pool.appendChild(tag);
    });
    $$('.dropSlot').forEach(slot=>{
      slot.ondragover = (e)=>{ e.preventDefault(); };
      slot.ondrop = (e)=>{
        e.preventDefault();
        const dragging=document.querySelector('.dragging'); if(!dragging) return;
        slot.textContent = dragging.textContent; slot.dataset.filled=dragging.textContent; dragging.remove();
      };
    });
  }
  function checkFill(){
    let ok=0;
    $$('.dropSlot').forEach(slot=>{
      const key = slot.getAttribute('data-slot');
      const target = fillTargets.find(t=>t.slot===key)?.word;
      if((slot.dataset.filled||'').trim().toLowerCase() === target.toLowerCase()){
        ok++; slot.style.outline='2px solid var(--ok)'; slot.style.borderRadius='6px'; 
      }else{
        slot.style.outline='2px solid var(--bad)'; slot.style.borderRadius='6px';
      }
    });
    const fb=$('#fbFill');
    fb.textContent = ok===fillTargets.length ? '¡Perfecto! Frase completada.' : `Correctas: ${ok}/${fillTargets.length}.`;
    fb.style.color = ok===fillTargets.length ? 'var(--ok)' : 'var(--bad)';
  }
  function resetFill(){ renderFill(); $('#fbFill').textContent=''; }

  /* ----------------- Juego 4: Match roles ----------------- */
  const rolesItems = [
    {txt:'Detener, comunicar, DISPATCH si no hay radio', role:'operador'},
    {txt:'Estacionar, freno, motor, interruptor general', role:'operador'},
    {txt:'Activar brigadas de emergencia', role:'supervisor'},
    {txt:'Aislar 250 m y controlar accesos con cierres físicos', role:'supervisor'},
    {txt:'Tomar control total de la situación', role:'brigada'},
    {txt:'Aplicar procedimientos específicos de siniestros', role:'brigada'},
    {txt:'Proveer agua para apagar fuego en neumáticos', role:'aljibes'},
    {txt:'Coordinar llegada y operación en zona segura', role:'aljibes'},
    {txt:'Recibir alertas TRACKING/DISPATCH y coordinar recursos', role:'despacho'},
    {txt:'Registrar evento y apoyar comunicaciones', role:'despacho'}
  ];
  const roleMap = {
    'role_operador':'operador',
    'role_supervisor':'supervisor',
    'role_brigada':'brigada',
    'role_aljibes':'aljibes',
    'role_despacho':'despacho'
  };
  function renderRoles(){
    Object.keys(roleMap).forEach(id=>{ document.getElementById(id).innerHTML=''; });
    $('#rolesPool').innerHTML='';
    rolesItems.slice().sort(()=>Math.random()-0.5).forEach(it=>{
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent=it.txt; tag.draggable=true; tag.dataset.role=it.role;
      tag.addEventListener('dragstart', ()=> tag.classList.add('dragging'));
      tag.addEventListener('dragend', ()=> tag.classList.remove('dragging'));
      $('#rolesPool').appendChild(tag);
    });
    Object.keys(roleMap).forEach(id=>{
      const z = document.getElementById(id);
      z.ondragover = (e)=>{ e.preventDefault(); };
      z.ondrop = (e)=>{
        e.preventDefault();
        const dragging=document.querySelector('.dragging'); if(dragging){ z.appendChild(dragging); dragging.classList.remove('dragging'); }
      };
    });
  }
  function checkRoles(){
    let ok=0, total=rolesItems.length;
    Object.keys(roleMap).forEach(id=>{
      const expected = roleMap[id];
      [...document.getElementById(id).querySelectorAll('.tag')].forEach(t=>{
        if(t.dataset.role===expected){ ok++; t.style.outline='2px solid var(--ok)'; } else { t.style.outline='2px solid var(--bad)'; }
      });
    });
    const fb=$('#fbRoles'); const pct=Math.round(ok/total*100);
    fb.textContent = `Resultado: ${ok}/${total} (${pct}%).`;
    fb.style.color = ok===total ? 'var(--ok)' : 'var(--bad)';
  }
  function resetRoles(){ renderRoles(); $('#fbRoles').textContent=''; }

  /* ----------------- Juego 5: Timed decisions ----------------- */
  const timedQuestions = [
    {q:'Percibes amago en motor. ¿Primera acción de control?', opts:['Percutar AFEX','Usar extintor de polvo','Abrir capó'], ok:0},
    {q:'No hay radio. ¿Qué haces?', opts:['Esperar a que vuelva','Activar emergencia por DISPATCH y enviar mensaje','Salir a buscar señal'], ok:1},
    {q:'El fuego se descontrola. ¿Acción?', opts:['Seguir intentando con extintor','Evacuar inmediatamente el camión','Esperar al supervisor'], ok:1},
    {q:'Neumático comprometido. ¿Por dónde evacúas?', opts:['Costado del neumático en llamas','Costado opuesto','Por atrás del camión'], ok:1},
    {q:'¿Quién toma control total si el fuego aumenta sin control primario?', opts:['Operador','Brigadas de emergencia','Despacho'], ok:1}
  ];
  let timedIndex=0, timedScore=0, remaining=10, timerId=null;
  function startTimer(){
    remaining=10; $('#timer').textContent='Tiempo: '+remaining;
    clearInterval(timerId);
    timerId = setInterval(()=>{
      remaining--; $('#timer').textContent='Tiempo: '+remaining;
      if(remaining<=0){ clearInterval(timerId); lockTimed(false); $('#fbTimed').textContent='Tiempo agotado.'; $('#fbTimed').style.color='var(--bad)'; }
    },1000);
  }
  function renderTimed(){
    const t = timedQuestions[timedIndex];
    $('#timedQuestion').innerHTML = '<strong>Escenario '+(timedIndex+1)+'</strong>: '+t.q;
    const wrap = $('#timedOpts'); wrap.innerHTML='';
    t.opts.forEach((txt,i)=>{
      const btn=document.createElement('button'); btn.className='btn-ghost'; btn.textContent=txt;
      btn.addEventListener('click', ()=>{ lockTimed(i===t.ok); });
      wrap.appendChild(btn);
    });
    $('#fbTimed').textContent=''; startTimer();
  }
  function lockTimed(correct){
    clearInterval(timerId);
    const t = timedQuestions[timedIndex];
    const buttons = $$('#timedOpts button');
    buttons.forEach((b,i)=>{
      b.disabled=true;
      if(i===t.ok){ b.classList.add('btn-sec'); }
      if(correct && i===t.ok){ b.style.outline='2px solid var(--ok)'; }
    });
    if(correct){ timedScore++; $('#fbTimed').textContent='¡Correcto!'; $('#fbTimed').style.color='var(--ok)'; }
    else { $('#fbTimed').textContent='Respuesta incorrecta o fuera de tiempo.'; $('#fbTimed').style.color='var(--bad)'; }
  }
  $('#nextTimed').addEventListener('click', ()=>{
    if(timedIndex<timedQuestions.length-1){ timedIndex++; renderTimed(); }
    else { $('#fbTimed').textContent = `Puntaje final: ${timedScore}/${timedQuestions.length}.`; $('#fbTimed').style.color = timedScore===timedQuestions.length?'var(--ok)':'var(--bad)'; }
  });

  /* ----------------- Quiz 20 preguntas ----------------- */
  const preguntas=[
    {q:'Ante amago/incendio, lo primero es…', opts:['Seguir conduciendo hasta una zona iluminada','Detener el equipo de inmediato','Tomar un extintor sin avisar'], ok:1},
    {q:'La comunicación inicial incluye…', opts:['Nombre, ubicación exacta, equipo, tipo de emergencia, personas y ayuda requerida','Solo nombre y equipo','Solo ubicación'], ok:0},
    {q:'El botón rojo corresponde al sistema…', opts:['TRACKING','GPS','CCTV'], ok:0},
    {q:'Si no hay radio, corresponde…', opts:['Esperar al supervisor','Activar emergencia en DISPATCH y enviar mensaje','Salir del equipo y gritar'], ok:1},
    {q:'Parada segura incluye…', opts:['Estacionar, freno, detener motor, desactivar interruptor general','Solo estacionar y freno','Solo detener motor'], ok:0},
    {q:'Incendio en motor: acción correcta…', opts:['Percutar AFEX','Usar extintor portátil','Abrir capó para ver mejor'], ok:0},
    {q:'Si el fuego no es en motor ni neumáticos…', opts:['Usar extintor y tratar de sofocar','No hacer nada','Saltar del camión'], ok:0},
    {q:'Si el fuego se descontrola…', opts:['Evacuar inmediatamente','Esperar brigada dentro del camión','Seguir intentándolo'], ok:0},
    {q:'Si el fuego aumenta y no se controla primariamente…', opts:['Supervisor solicita brigadas de emergencia','Operador llama a un amigo','Se suspende la comunicación'], ok:0},
    {q:'Evacuación con neumático comprometido se realiza…', opts:['Por el costado opuesto al neumático en llamas','Por el mismo costado','Por el frente del camión'], ok:0},
    {q:'El supervisor debe aislar…', opts:['250 metros de radio','50 metros de radio','Sin aislamiento'], ok:0},
    {q:'El control de accesos se realiza con…', opts:['Cierres físicos','Conos pequeños únicamente','Cinta plástica fina'], ok:0},
    {q:'Está prohibido…', opts:['Acercarse al neumático afectado o usar extintor/mangueras sobre él','Informar la emergencia','Aislar el sector'], ok:0},
    {q:'La única forma de apagar fuego en neumáticos es…', opts:['Agua con camiones aljibes','Extintor de polvo químico','Manguera de jardín'], ok:0},
    {q:'¿Quién toma el control total de la situación cuando se requiere?', opts:['Brigadas de emergencia','Operador','Vigilante de portería'], ok:0},
    {q:'El supervisor debe actuar según…', opts:['Procedimiento general de emergencias de producción mina','Criterio personal','Normas de tránsito'], ok:0},
    {q:'La ubicación del AFEX está…', opts:['Dentro de la cabina a la derecha del operador','En el exterior del motor','En la rueda delantera'], ok:0},
    {q:'El rol de despacho/control incluye…', opts:['Recibir alertas y coordinar recursos','Operar el AFEX','Apagar el neumático con extintor'], ok:0},
    {q:'El mensaje por radio debe ser…', opts:['Claro, con lugar exacto y requerimientos','Solo “incendio” repetido','Un audio largo sin detalles'], ok:0},
    {q:'Tras el control, se reanuda la operación…', opts:['Cuando lo indique la jefatura competente según procedimiento','Apenas baje el humo','A decisión del operador'], ok:0}
  ];
  function renderQuiz(){
    const wrap=$('#quiz'); wrap.innerHTML='';
    preguntas.forEach((p,i)=>{
      const div=document.createElement('div');
      div.className='q'; div.dataset.index=i; div.dataset.ok=p.ok;
      div.innerHTML=`<div style="font-weight:700">${i+1}. ${p.q}</div>` + p.opts.map((txt,j)=>`<label class="opt"><input type="radio" name="q${i}" value="${j}"> <span>${txt}</span></label>`).join('');
      wrap.appendChild(div);
    });
  }
  function lockQuizAndColor(){
    const blocks = $$('#quiz .q');
    let okCount=0, wrongCount=0, unanswered=0;
    blocks.forEach((div)=>{
      const ok = Number(div.dataset.ok);
      const sel = div.querySelector('input[type="radio"]:checked');
      div.querySelectorAll('input').forEach(inp=> inp.disabled=true);
      const correctLabel = div.querySelector(`input[value="${ok}"]`)?.closest('label');
      correctLabel?.classList.add('correct');
      if(!sel){ div.classList.add('wrong'); unanswered++; wrongCount++; return; }
      const chosen = Number(sel.value);
      if(chosen===ok){ div.classList.add('correct'); okCount++; }
      else { div.classList.add('wrong'); sel.closest('label')?.classList.add('wrong'); wrongCount++; }
    });
    const total = preguntas.length;
    const pct = Math.round(okCount/total*100);
    const fb = `Resultado: ${okCount}/${total} (${pct}%). ✅ Correctas en verde · ❌ Incorrectas en rojo${unanswered?` · ${unanswered} sin responder`:''}.`;
    $('#quizFeedback').textContent = fb;
    $('#quizFeedback').style.color = okCount===total? 'var(--ok)':'var(--bad)';
  }
  function resetQuizColors(){
    $$('#quiz .q').forEach(div=>{
      div.classList.remove('correct','wrong');
      div.querySelectorAll('label').forEach(l=> l.classList.remove('correct','wrong'));
      div.querySelectorAll('input').forEach(inp=>{ inp.disabled=false; inp.checked=false; });
    });
    $('#quizFeedback').textContent='';
  }

  // Enlaces UI
  $('#checkOrden').addEventListener('click', checkOrden);
  $('#regenOrden').addEventListener('click', renderOrdenar);
  $('#checkClasif').addEventListener('click', checkClasif);
  $('#resetClasif').addEventListener('click', resetClasif);
  $('#checkFill').addEventListener('click', checkFill);
  $('#resetFill').addEventListener('click', resetFill);
  $('#checkRoles').addEventListener('click', checkRoles);
  $('#resetRoles').addEventListener('click', resetRoles);
  $('#enviar').addEventListener('click', ()=>{ lockQuizAndColor(); state.done.quiz=true; store('anupro360_s24_incendio', state); calcProgress(); });
  $('#resetQuiz').addEventListener('click', ()=>{ resetQuizColors(); state.done.quiz=false; store('anupro360_s24_incendio', state); calcProgress(); });

  /* Reflexión */
  const ref = $('#reflexion'); ref.value = state.reflexion||'';
  $('#guardarRef').addEventListener('click', ()=>{ state.reflexion = (ref.value||'').trim(); store('anupro360_s24_incendio', state); alert('Reflexión guardada en este dispositivo.'); });
  $('#copiarRef').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText((ref.value||'').trim()); alert('Texto copiado. Pégalo en Classroom.'); }catch(e){ alert('No se pudo copiar automáticamente. Copia manualmente.'); } });

  /* Init */
  renderOrdenar();
  renderClasif();
  renderFill();
  renderRoles();
  renderTimed();
  renderQuiz();
  calcProgress();
  $('#year').textContent = new Date().getFullYear();
</script>
</body>
</html>
