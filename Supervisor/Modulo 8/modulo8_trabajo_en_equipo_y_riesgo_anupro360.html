<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√≥dulo 8 ¬∑ Trabajo en Equipo y Control del Riesgo ‚Äî ANUPRO360</title>
  <meta name="description" content="M√≥dulo 8 (autoaprendizaje): Trabajo en Equipo y Control del Riesgo. Incluye pr√°ctica guiada, drag & drop t√°ctil, simulador STOP WORK y mini-quiz con retroalimentaci√≥n."/>
  <style>
    :root{
      --amarillo:#FFB81C; /* Amarillo Minero */
      --naranja:#FF5C00;  /* Naranja */
      --gris:#5C6B6B;     /* Gris Acero */
      --verde:#4B6F44;    /* Verde Mineral */
      --azul:#003B5C;     /* Azul Oscuro */
      --blanco:#FFFFFF;   /* Blanco */

      --bg1:#071621;
      --bg2:#0b2434;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --muted:rgba(255,255,255,.72);
      --text:#eef6ff;
      --shadow:0 10px 28px rgba(0,0,0,.28);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,184,28,.14), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,92,0,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1120px; margin:0 auto; padding:18px}
    header{
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, rgba(255,184,28,.9), rgba(255,92,0,.9));
      box-shadow: 0 0 0 1px rgba(255,255,255,.12), 0 12px 26px rgba(255,92,0,.18);
      display:grid; place-items:center;
      font-weight:900; color:#1b1b1b;
      user-select:none;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      font-size:12px; color:var(--muted);
    }
    .hero{padding:16px 0 6px}
    .hero h2{margin:.2rem 0 .3rem; font-size:1.45rem}
    .hero p{margin:0; color:var(--muted); line-height:1.5}
    .progress{
      height:10px; width:100%; border-radius:999px;
      background: rgba(255,255,255,.12);
      overflow:hidden;
    }
    .progress > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--amarillo), var(--naranja));
      transition: width .35s ease;
    }

    .grid{display:grid; gap:16px; margin-top:16px}
    @media(min-width:980px){ .grid{grid-template-columns:1.25fr .75fr} }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h3{margin:0 0 10px; font-size:1.05rem}
    .card p{margin:.5rem 0; color:var(--muted); line-height:1.55}
    .small{font-size:12px; color:rgba(255,255,255,.68)}
    .kpi{
      display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px
    }
    .kpi > div{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
    }
    .kpi b{display:block; font-size:18px; color:var(--amarillo)}
    .kpi span{font-size:12px; color:rgba(255,255,255,.72)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{font:inherit}
    .btn, .btn-sec, .btn-ghost{
      cursor:pointer; border:none; border-radius:12px;
      padding:10px 14px; font-weight:700;
      transition: transform .08s ease, filter .15s ease, background .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn{background: linear-gradient(180deg, var(--amarillo), var(--naranja)); color:#1b1b1b}
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:translateY(1px)}
    .btn-sec{background: rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.14)}
    .btn-ghost{background: transparent; color:var(--muted); border:1px dashed rgba(255,255,255,.18)}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.78);
      font-size:12px;
    }
    .tag i{width:8px; height:8px; border-radius:50%; display:inline-block; background:var(--verde)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:14px 0}

    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
    }
    details + details{margin-top:10px}
    summary{cursor:pointer; font-weight:800}
    summary::marker{color:rgba(255,255,255,.55)}
    .callout{
      border-left:4px solid var(--amarillo);
      background: rgba(255,184,28,.08);
      padding:12px; border-radius:12px;
    }
    .callout b{color:var(--amarillo)}

    /* Interactive: Top 3 */
    .form-grid{display:grid; gap:10px}
    @media(min-width:700px){ .form-grid{grid-template-columns:1fr 1fr} }
    label{display:block; font-size:12px; color:rgba(255,255,255,.72); margin-bottom:6px}
    select, input[type="text"], textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .hint{font-size:12px; color:rgba(255,255,255,.65)}
    .ok{color:#8cff98}
    .warn{color:#ffd27a}
    .bad{color:#ff9b9b}

    /* Drag & Drop */
    .dd{
      display:grid; gap:12px;
    }
    @media(min-width:880px){ .dd{grid-template-columns:1fr 1fr} }
    .dd-col{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
      min-height:140px;
    }
    .dd-col h4{margin:0 0 10px; font-size:14px; color:rgba(255,255,255,.86)}
    .chip{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      margin:8px 0;
      touch-action:none; /* important for touch dragging */
    }
    .chip b{font-size:13px}
    .chip small{opacity:.75}
    .chip[draggable="true"]{cursor:grab}
    .chip:active{cursor:grabbing}
    .dropzone{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px;
      padding:10px 12px;
      margin:8px 0;
      min-height:48px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.12);
    }
    .dropzone.dragover{
      border-color: rgba(140,255,152,.65);
      background: rgba(140,255,152,.10);
    }
    .dz-title{font-weight:800; font-size:12px; opacity:.9}
    .dz-value{font-size:12px; color:rgba(255,255,255,.70)}
    .dd-result{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      font-size:13px;
    }

    /* STOP WORK */
    .scenario{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
    }
    .choices{display:grid; gap:10px; margin-top:10px}
    @media(min-width:700px){ .choices{grid-template-columns:1fr 1fr} }
    .choice{
      padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .choice:hover{background: rgba(255,255,255,.08)}
    .choice:active{transform:translateY(1px)}
    .choice.correct{border-color: rgba(140,255,152,.70); background: rgba(140,255,152,.12)}
    .choice.incorrect{border-color: rgba(255,155,155,.70); background: rgba(255,155,155,.10)}
    .toast{
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px; border-radius:999px;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      z-index:99;
      display:none;
      max-width:min(94vw, 820px);
      color:rgba(255,255,255,.90);
      font-size:13px;
    }

    /* Quiz */
    .qhead{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .qmeta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .badge{
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:rgba(255,255,255,.78);
    }
    .question{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight:800;
      line-height:1.4;
    }
    .opt{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      transition:.12s;
    }
    .opt:hover{background: rgba(255,255,255,.07)}
    .opt.selected{border-color: rgba(255,184,28,.65); background: rgba(255,184,28,.10)}
    .opt.correct{border-color: rgba(140,255,152,.70); background: rgba(140,255,152,.12)}
    .opt.incorrect{border-color: rgba(255,155,155,.70); background: rgba(255,155,155,.10)}
    .explain{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:rgba(255,255,255,.78);
      font-size:13px;
    }
    footer{padding:18px 0 26px; color:rgba(255,255,255,.62); font-size:12px}
    .right .card{position:sticky; top:14px}
  </style>
</head>
<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">A360</div>
        <div>
          <h1>ANUPRO360 ¬∑ Supervisor de √Årea Mina</h1>
          <p>M√≥dulo 8 (Autoaprendizaje) ¬∑ Trabajo en Equipo y Control del Riesgo</p>
        </div>
      </div>

      <div class="pill" title="Progreso guardado autom√°ticamente en este dispositivo">
        <span>üìà Progreso</span>
        <span style="min-width:48px; text-align:right"><b id="pct">0%</b></span>
      </div>
    </div>

    <div class="wrap hero">
      <h2>Aprende a controlar el riesgo <span style="color:var(--amarillo)">con el equipo</span>, no ‚Äúsolo con reglas‚Äù.</h2>
      <p>
        Este m√≥dulo te entrena para identificar riesgos, definir controles <strong>concretos</strong>, verificar barreras cr√≠ticas y decidir cu√°ndo aplicar <strong>STOP WORK</strong>.
        Incluye pr√°ctica guiada, drag &amp; drop t√°ctil y mini‚Äëquiz con retroalimentaci√≥n.
      </p>
      <div class="divider"></div>
      <div class="progress" aria-label="Barra de progreso"><i id="bar"></i></div>
      <div class="small" style="margin-top:8px">Tip: marca cada secci√≥n como completada para avanzar. Todo queda guardado.</div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT -->
    <section class="left">
      <!-- 1) C√≥mo usar -->
      <article class="card" data-section="s1">
        <div class="row" style="justify-content:space-between">
          <h3>1) C√≥mo usar este m√≥dulo (sin profesor)</h3>
          <span class="tag"><i></i> Autoaprendizaje</span>
        </div>
        <p>
          Estudiar√°s con la l√≥gica <strong>Leer ‚Üí Aplicar ‚Üí Verificar</strong>. En mina, ‚Äúentender‚Äù no basta: debes poder <strong>ejecutar</strong> en turno.
        </p>
        <details>
          <summary>Rutina recomendada (20‚Äì30 min)</summary>
          <p><b>1)</b> Lee el concepto operativo (2‚Äì3 min).</p>
          <p><b>2)</b> Haz la pr√°ctica guiada (10‚Äì15 min).</p>
          <p><b>3)</b> Completa el juego Drag &amp; Drop (3‚Äì6 min).</p>
          <p><b>4)</b> Resuelve 1 escenario STOP WORK (2‚Äì4 min).</p>
          <p><b>5)</b> Mini‚Äëquiz (5‚Äì8 min) + reflexi√≥n (2 min).</p>
        </details>
        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s1_state"></div>
      </article>

      <!-- 2) Concepto -->
      <article class="card" data-section="s2">
        <div class="row" style="justify-content:space-between">
          <h3>2) Qu√© significa ‚Äúcontrol del riesgo‚Äù en equipo</h3>
          <span class="tag"><i style="background:var(--amarillo)"></i> Barreras</span>
        </div>
        <p>
          Controlar riesgo no es ‚Äútener cuidado‚Äù. Es asegurar que existan <strong>barreras</strong> (controles) que eviten que un peligro se transforme en incidente.
          Cuando el control depende de una sola persona, es fr√°gil. Cuando el control es <strong>del equipo</strong>, se vuelve robusto.
        </p>

        <div class="callout">
          <b>Definici√≥n operacional:</b><br/>
          Un riesgo est√° controlado cuando el equipo puede responder ‚ÄúS√≠‚Äù a 3 preguntas:
          <div class="divider"></div>
          <p>‚úÖ <b>Control:</b> ¬øQu√© barrera concreta est√° instalada?</p>
          <p>‚úÖ <b>Verificaci√≥n:</b> ¬øC√≥mo verificamos que funciona (evidencia)?</p>
          <p>‚úÖ <b>Acci√≥n:</b> ¬øQu√© hacemos si falla (escalamiento / STOP WORK)?</p>
        </div>

        <details>
          <summary>Ejemplo r√°pido (Tr√°nsito interno)</summary>
          <p><b>Peligro:</b> Interacciones CAEX / livianos en cruces.</p>
          <p><b>Control concreto:</b> segregaci√≥n de rutas + se√±alizaci√≥n + l√≠mite de velocidad + control en puntos cr√≠ticos.</p>
          <p><b>Verificaci√≥n:</b> observaci√≥n en terreno + registro de control de velocidad + checklist de se√±al√©tica.</p>
          <p><b>Acci√≥n si falla:</b> restringir cruce / detener actividad / escalar a Control + SSO.</p>
        </details>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s2_state"></div>
      </article>

      <!-- 3) Top 3 riesgos interactivo -->
      <article class="card" data-section="s3">
        <div class="row" style="justify-content:space-between">
          <h3>3) Top 3 Riesgos del Turno (pr√°ctica interactiva)</h3>
          <span class="tag"><i style="background:var(--verde)"></i> Aplicaci√≥n</span>
        </div>
        <p>
          La herramienta m√°s simple y efectiva para un supervisor en turno es levantar el <strong>Top 3</strong> de riesgos y definir
          <strong>control + verificaci√≥n</strong>. Aqu√≠ lo practicar√°s como si fuera tu briefing.
        </p>

        <div class="form-grid" id="top3">
          <!-- rows injected by JS -->
        </div>

        <div class="divider"></div>
        <div class="row" style="justify-content:space-between">
          <div class="small">
            Criterio de calidad: evita controles vagos como ‚Äúestar atento‚Äù. Usa acciones verificables: <i>se√±alizar, aislar, medir, bloquear, registrar</i>.
          </div>
          <span class="badge" id="top3_quality">Calidad: ‚Äî</span>
        </div>

        <div class="btnrow">
          <button class="btn" id="saveTop3">üíæ Guardar Top 3</button>
          <button class="btn-sec" id="autoFeedback">üß† Revisar calidad</button>
          <button class="btn-ghost" id="resetTop3">‚Ü∫ Reiniciar</button>
        </div>

        <div class="dd-result" id="top3_feedback">Completa el Top 3 y presiona ‚ÄúRevisar calidad‚Äù.</div>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s3_state"></div>
      </article>

      <!-- 4) Drag drop -->
      <article class="card" data-section="s4">
        <div class="row" style="justify-content:space-between">
          <h3>4) Juego: Riesgo ‚Üí Control ‚Üí Verificaci√≥n (Drag &amp; Drop t√°ctil)</h3>
          <span class="tag"><i style="background:var(--naranja)"></i> Juego</span>
        </div>
        <p>
          Arrastra cada <b>control</b> a su <b>riesgo</b> correcto. Este ejercicio entrena rapidez mental para ‚Äúpensar en barreras‚Äù, no solo en peligros.
          Funciona con mouse y con <b>pantalla t√°ctil</b>.
        </p>

        <div class="dd" id="dd">
          <div class="dd-col">
            <h4>Controles disponibles (arrastra)</h4>
            <div id="dd_controls"></div>
            <div class="small">Tip: si est√°s en celular, mant√©n presionado y suelta sobre el riesgo.</div>
          </div>
          <div class="dd-col">
            <h4>Riesgos del turno (suelta aqu√≠)</h4>
            <div id="dd_zones"></div>
            <div class="dd-result" id="dd_feedback">Completa todas las asignaciones y presiona ‚ÄúVerificar‚Äù.</div>
            <div class="btnrow">
              <button class="btn" id="dd_check">‚úÖ Verificar</button>
              <button class="btn-sec" id="dd_reset">‚Ü∫ Reiniciar</button>
            </div>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s4_state"></div>
      </article>

      <!-- 5) STOP WORK -->
      <article class="card" data-section="s5">
        <div class="row" style="justify-content:space-between">
          <h3>5) Simulador: decisi√≥n STOP WORK (√°rbol pr√°ctico)</h3>
          <span class="tag"><i style="background:#ff7777"></i> Decisi√≥n</span>
        </div>
        <p>
          En presi√≥n, el error t√≠pico es seguir operando ‚Äúpara no atrasar‚Äù. Aqu√≠ entrenas el criterio:
          <strong>Seguridad ‚Üí Continuidad ‚Üí Producci√≥n</strong>. Resuelve escenarios y recibe retroalimentaci√≥n inmediata.
        </p>

        <div class="scenario">
          <div class="qhead">
            <div class="qmeta">
              <span class="badge">Escenario <b id="sc_idx">1</b>/<span id="sc_total">4</span></span>
              <span class="badge">Puntaje: <b id="sc_score">0</b></span>
            </div>
            <div class="btnrow" style="margin:0">
              <button class="btn-sec" id="sc_next">Siguiente ‚ñ∂</button>
              <button class="btn-ghost" id="sc_reset">‚Ü∫ Reiniciar</button>
            </div>
          </div>

          <div class="question" id="sc_text">‚Äî</div>
          <div class="choices" id="sc_choices"></div>
          <div class="explain" id="sc_explain">Selecciona una acci√≥n. Tu meta es decidir r√°pido y bien.</div>
        </div>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s5_state"></div>
      </article>

      <!-- 6) Correcto vs incorrecto -->
      <article class="card" data-section="s6">
        <div class="row" style="justify-content:space-between">
          <h3>6) Ejemplos: conducta correcta vs. incorrecta</h3>
          <span class="tag"><i style="background:var(--gris)"></i> Criterio</span>
        </div>
        <p>Compara escenarios t√≠picos de turno. La idea es internalizar ‚Äúqu√© se ve‚Äù cuando el riesgo est√° controlado (o no).</p>

        <details>
          <summary>Ejemplo A: Interacci√≥n de equipos en zona de cargu√≠o</summary>
          <p><b>Incorrecto:</b> CAEX acerc√°ndose sin se√±alero/segregaci√≥n, radios saturadas, nadie confirma, ‚Äúavancen no m√°s‚Äù.</p>
          <p><b>Correcto:</b> zona delimitada + se√±alero activo + confirmaci√≥n por radio + velocidad controlada + verificaci√≥n visual.</p>
          <p class="hint">Indicador de control: todos pueden describir el control en una frase (‚Äúzona segregada con se√±alero y confirmaci√≥n‚Äù).</p>
        </details>

        <details>
          <summary>Ejemplo B: Mantenci√≥n solicita intervenci√≥n ‚Äúr√°pida‚Äù</summary>
          <p><b>Incorrecto:</b> se interviene con √°rea operando, sin aislamiento, ‚Äúsolo es un minuto‚Äù.</p>
          <p><b>Correcto:</b> ventana coordinada + √°rea aislada + permiso/LOTO si aplica + liberaci√≥n formal a Control/Operaci√≥n.</p>
        </details>

        <details>
          <summary>Ejemplo C: Presi√≥n por meta de producci√≥n</summary>
          <p><b>Incorrecto:</b> se reduce inspecci√≥n / se omiten confirmaciones / se acelera en rampas.</p>
          <p><b>Correcto:</b> se priorizan controles cr√≠ticos, se comunica plan B, y se ajusta la meta con trazabilidad.</p>
        </details>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s6_state"></div>
      </article>

      <!-- 7) Actividades -->
      <article class="card" data-section="s7">
        <div class="row" style="justify-content:space-between">
          <h3>7) Actividades guiadas (aprende aplicando)</h3>
          <span class="tag"><i style="background:var(--verde)"></i> Pr√°ctica</span>
        </div>

        <details open>
          <summary>Actividad 1: Briefing Top 3 riesgos (texto listo)</summary>
          <p>Escribe tu briefing como si hablaras al equipo (m√°x. 60 segundos):</p>
          <textarea id="act1" placeholder="Ejemplo: 'Equipo, meta del turno..., Top 3 riesgos..., controles..., si falla control: STOP WORK y me avisan...'"></textarea>
          <div class="btnrow">
            <button class="btn" id="saveAct1">üíæ Guardar</button>
            <button class="btn-sec" id="copyAct1">üìã Copiar</button>
          </div>
          <div class="small" id="act1_state"></div>
        </details>

        <details>
          <summary>Actividad 2: Verificaci√≥n de barrera (evidencia)</summary>
          <p>Elige un control cr√≠tico (ej.: se√±alero, segregaci√≥n, checklist preoperacional) y define c√≥mo lo verificar√°s en terreno.</p>
          <div class="form-grid">
            <div>
              <label>Control cr√≠tico</label>
              <input type="text" id="act2_control" placeholder="Ej.: Segregaci√≥n de rutas en cruce norte" />
            </div>
            <div>
              <label>Evidencia / verificaci√≥n (observable)</label>
              <input type="text" id="act2_evidence" placeholder="Ej.: Observaci√≥n + foto + registro de checklist se√±al√©tica" />
            </div>
          </div>
          <div class="btnrow">
            <button class="btn" id="saveAct2">üíæ Guardar</button>
          </div>
          <div class="small" id="act2_state"></div>
        </details>

        <details>
          <summary>Actividad 3: Plan de acci√≥n si falla el control</summary>
          <p>Completa la regla ‚ÄúSi pasa X, hacemos Y‚Äù (para evitar improvisaci√≥n bajo presi√≥n):</p>
          <div class="form-grid">
            <div>
              <label>Si falla (evento)</label>
              <input type="text" id="act3_event" placeholder="Ej.: se√±alero no est√° presente / ruta no segregada" />
            </div>
            <div>
              <label>Hacemos (acci√≥n)</label>
              <input type="text" id="act3_action" placeholder="Ej.: detengo el cruce, reasigno ruta, aviso Control + SSO, registro" />
            </div>
          </div>
          <div class="btnrow">
            <button class="btn" id="saveAct3">üíæ Guardar</button>
          </div>
          <div class="small" id="act3_state"></div>
        </details>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s7_state"></div>
      </article>

      <!-- 8) Quiz -->
      <article class="card" data-section="s8">
        <div class="row" style="justify-content:space-between">
          <h3>8) Mini‚Äëquiz (12 preguntas) ‚Äî retroalimentaci√≥n visual</h3>
          <span class="tag"><i style="background:var(--amarillo)"></i> Evaluaci√≥n</span>
        </div>
        <p>
          Preguntas de criterio operativo (no de memoria). Responde y revisa la explicaci√≥n.
          Meta recomendada: <strong>80%</strong> o m√°s.
        </p>

        <div class="scenario" id="quiz">
          <div class="qhead">
            <div class="qmeta">
              <span class="badge">Pregunta <b id="q_idx">1</b>/<span id="q_total">12</span></span>
              <span class="badge">Puntaje: <b id="q_score">0</b></span>
              <span class="badge">Mejor: <b id="q_best">‚Äî</b></span>
            </div>
            <div class="btnrow" style="margin:0">
              <button class="btn-sec" id="q_prev">‚óÄ Anterior</button>
              <button class="btn-sec" id="q_next">Siguiente ‚ñ∂</button>
              <button class="btn" id="q_finish">Finalizar</button>
              <button class="btn-ghost" id="q_reset">‚Ü∫ Reiniciar</button>
            </div>
          </div>

          <div class="question" id="q_text">‚Äî</div>
          <div id="q_opts"></div>
          <div class="explain" id="q_explain">Selecciona una alternativa para ver retroalimentaci√≥n.</div>
        </div>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s8_state"></div>
      </article>

      <!-- 9) Reflexi√≥n -->
      <article class="card" data-section="s9">
        <div class="row" style="justify-content:space-between">
          <h3>9) Reflexi√≥n (para llevar al turno)</h3>
          <span class="tag"><i style="background:var(--azul)"></i> Transferencia</span>
        </div>
        <p>Escribe 3 compromisos concretos para tu pr√≥ximo turno. Deben ser acciones observables.</p>
        <textarea id="reflection" placeholder="1) ...&#10;2) ...&#10;3) ..."></textarea>
        <div class="btnrow">
          <button class="btn" id="saveReflection">üíæ Guardar</button>
          <button class="btn-sec" id="copyReflection">üìã Copiar</button>
        </div>
        <div class="small" id="ref_state"></div>

        <div class="btnrow">
          <button class="btn-sec" data-action="toggleComplete">‚úÖ Marcar como completado</button>
          <button class="btn-ghost" data-action="resetSection">‚Ü∫ Reiniciar secci√≥n</button>
        </div>
        <div class="small" id="s9_state"></div>
      </article>

      <footer class="wrap" style="padding-left:0;padding-right:0">
        ¬© Copyright Anupro360 2025. Todos los derechos reservados.
      </footer>
    </section>

    <!-- RIGHT -->
    <aside class="right">
      <div class="card">
        <h3>Ficha del M√≥dulo 8</h3>
        <div class="divider"></div>
        <p class="small"><b>Competencia:</b> Coordinar el trabajo en equipo asegurando control del riesgo (barreras y verificaci√≥n).</p>
        <div class="kpi">
          <div><b>30 min</b><span>Tiempo recomendado</span></div>
          <div><b>12</b><span>Preguntas mini‚Äëquiz</span></div>
          <div><b>4</b><span>Escenarios STOP WORK</span></div>
          <div><b>1</b><span>Juego Drag &amp; Drop</span></div>
        </div>

        <div class="divider"></div>
        <h3 style="font-size:14px; margin-bottom:8px">Herramientas r√°pidas</h3>
        <div class="btnrow">
          <button class="btn-sec" id="copyChecklist">üìã Copiar Checklist</button>
          <button class="btn-sec" id="copySBAR">üìª Copiar SBAR</button>
          <button class="btn-ghost" id="resetAll">‚ö†Ô∏è Reiniciar todo</button>
        </div>

        <div class="divider"></div>
        <div class="small" id="last_saved">‚Äî</div>
      </div>
    </aside>
  </main>

  <script>
    // ---------- Storage helpers ----------
    const KEY = "a360_mod8_riesgo_v1";
    const nowISO = ()=> new Date().toISOString();
    const load = () => {
      try { return JSON.parse(localStorage.getItem(KEY)) || {}; }
      catch { return {}; }
    };
    const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

    const toast = (msg) => {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", 1600);
    };

    // ---------- Progress ----------
    const sections = ["s1","s2","s3","s4","s5","s6","s7","s8","s9"];
    function computeProgress(state){
      const done = sections.filter(s => state.completed?.includes(s)).length;
      const total = sections.length;
      const pct = Math.round((done/total)*100);
      return {done, total, pct};
    }
    function renderProgress(){
      const st = load();
      const {pct} = computeProgress(st);
      document.getElementById("pct").textContent = pct+"%";
      document.getElementById("bar").style.width = pct+"%";
      // per-section state labels
      sections.forEach(id=>{
        const el = document.getElementById(id+"_state");
        if(!el) return;
        const done = st.completed?.includes(id);
        el.textContent = done ? "Estado: ‚úÖ completado" : "Estado: ‚è≥ pendiente";
      });
      document.getElementById("last_saved").textContent =
        st.lastSaved ? ("√öltimo guardado: " + new Date(st.lastSaved).toLocaleString()) : "Sin guardados a√∫n";
    }
    function toggleComplete(sectionId){
      const st = load();
      st.completed = st.completed || [];
      const idx = st.completed.indexOf(sectionId);
      if(idx >= 0) st.completed.splice(idx,1);
      else st.completed.push(sectionId);
      st.lastSaved = nowISO();
      save(st);
      renderProgress();
      toast(idx>=0 ? "Secci√≥n marcada como pendiente" : "Secci√≥n completada ‚úÖ");
    }
    function resetSection(sectionId){
      const st = load();
      st.completed = (st.completed||[]).filter(x=>x!==sectionId);
      // also clear section-specific content where applicable
      if(sectionId==="s3"){ st.top3 = null; }
      if(sectionId==="s4"){ st.dd = null; }
      if(sectionId==="s5"){ st.sc = null; }
      if(sectionId==="s7"){ st.act1=null; st.act2=null; st.act3=null; }
      if(sectionId==="s8"){ st.quiz=null; }
      if(sectionId==="s9"){ st.reflection=null; }
      st.lastSaved = nowISO();
      save(st);
      // re-render interactive parts
      initTop3();
      initDragDrop();
      initScenario();
      initActivities();
      initQuiz();
      renderProgress();
      toast("Secci√≥n reiniciada ‚Ü∫");
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const action = btn.dataset.action;
      const card = btn.closest(".card");
      if(!action || !card) return;
      const sectionId = card.dataset.section;
      if(action==="toggleComplete") toggleComplete(sectionId);
      if(action==="resetSection") resetSection(sectionId);
    });

    // ---------- Top 3 interactive ----------
    const RISK_OPTIONS = [
      "Tr√°nsito interno / interacci√≥n livianos‚ÄìCAEX",
      "Interferencia en zona de cargu√≠o (pala‚ÄìCAEX‚Äìpersonas)",
      "Fatiga / somnolencia (turno largo / conducci√≥n)",
      "Condici√≥n de rampa (pendiente, bermas, material suelto)",
      "Clima extremo (viento/polvo/lluvia)",
      "Energ√≠as peligrosas (LOTO / intervenci√≥n)",
      "P√©rdida de comunicaci√≥n (radio / se√±al)",
      "Derrame de combustible/aceite",
      "Trabajo en altura / acceso",
      "Herramientas/objetos sueltos (FOD)"
    ];
    const CONTROL_SUGGEST = {
      "Tr√°nsito interno / interacci√≥n livianos‚ÄìCAEX": ["Segregaci√≥n de rutas", "L√≠mite de velocidad", "Control en cruces (se√±alero)", "Prohibici√≥n de adelantamiento"],
      "Interferencia en zona de cargu√≠o (pala‚ÄìCAEX‚Äìpersonas)": ["Zona delimitada", "Se√±alero", "Comunicaci√≥n y confirmaci√≥n", "Ruta √∫nica entrada/salida"],
      "Fatiga / somnolencia (turno largo / conducci√≥n)": ["Pausas planificadas", "Rotaci√≥n de tarea", "Chequeo de aptitud", "Monitoreo / reporte"],
      "Condici√≥n de rampa (pendiente, bermas, material suelto)": ["Inspecci√≥n de rampa", "Mantenci√≥n de bermas", "Riego/control de polvo", "Restricci√≥n de velocidad"],
      "Clima extremo (viento/polvo/lluvia)": ["Restricci√≥n de operaci√≥n", "Ajuste de rutas", "Detenci√≥n temporal", "Verificaci√≥n de visibilidad"],
      "Energ√≠as peligrosas (LOTO / intervenci√≥n)": ["Aislamiento de energ√≠a", "Permiso de trabajo", "Bloqueo/etiquetado", "Liberaci√≥n formal"],
      "P√©rdida de comunicaci√≥n (radio / se√±al)": ["Canal alternativo", "Puntos de reporte", "Restricci√≥n de movimiento", "Protocolos de se√±alizaci√≥n"],
      "Derrame de combustible/aceite": ["Contenci√≥n inmediata", "Kit de derrames", "Aislar √°rea", "Reporte y disposici√≥n"],
      "Trabajo en altura / acceso": ["Barandas/linea de vida", "Permiso", "Inspecci√≥n de anclajes", "Supervisi√≥n directa"],
      "Herramientas/objetos sueltos (FOD)": ["Orden y limpieza", "Inspecci√≥n previa", "Contenci√≥n/portaherramientas", "Revisi√≥n de cabina"]
    };

    function buildTop3UI(){
      const root = document.getElementById("top3");
      root.innerHTML = "";
      for(let i=1;i<=3;i++){
        const row = document.createElement("div");
        row.className = "card";
        row.style.padding = "12px";
        row.style.boxShadow = "none";
        row.style.background = "rgba(0,0,0,.16)";
        row.style.borderRadius = "14px";
        row.style.border = "1px solid rgba(255,255,255,.10)";
        row.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <b>Riesgo #${i}</b>
            <span class="badge" id="q_r${i}">‚Äî</span>
          </div>
          <div class="divider"></div>
          <label>Riesgo</label>
          <select id="r${i}_risk">
            <option value="">Selecciona‚Ä¶</option>
            ${RISK_OPTIONS.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("")}
          </select>
          <div class="divider"></div>
          <div class="form-grid">
            <div>
              <label>Control (barrera concreta)</label>
              <input type="text" id="r${i}_control" placeholder="Ej.: segregaci√≥n de rutas + se√±alero" />
              <div class="hint" id="r${i}_hint"></div>
            </div>
            <div>
              <label>Verificaci√≥n (evidencia observable)</label>
              <input type="text" id="r${i}_verify" placeholder="Ej.: observaci√≥n + registro checklist" />
              <div class="hint">Evita: ‚Äúrevisar‚Äù sin indicar qu√© evidencia.</div>
            </div>
          </div>
        `;
        root.appendChild(row);
      }
    }

    function initTop3(){
      const st = load();
      buildTop3UI();

      const saved = st.top3 || [];
      for(let i=1;i<=3;i++){
        const item = saved[i-1] || {};
        const riskSel = document.getElementById(`r${i}_risk`);
        const ctl = document.getElementById(`r${i}_control`);
        const ver = document.getElementById(`r${i}_verify`);
        riskSel.value = item.risk || "";
        ctl.value = item.control || "";
        ver.value = item.verify || "";
        updateTop3Hints(i);
        updateRowQuality(i);
        riskSel.addEventListener("change", ()=>{ updateTop3Hints(i); updateRowQuality(i); });
        ctl.addEventListener("input", ()=> updateRowQuality(i));
        ver.addEventListener("input", ()=> updateRowQuality(i));
      }

      document.getElementById("saveTop3").onclick = ()=>{
        const data = [];
        for(let i=1;i<=3;i++){
          data.push({
            risk: document.getElementById(`r${i}_risk`).value.trim(),
            control: document.getElementById(`r${i}_control`).value.trim(),
            verify: document.getElementById(`r${i}_verify`).value.trim()
          });
        }
        st.top3 = data;
        st.lastSaved = nowISO();
        save(st);
        renderProgress();
        toast("Top 3 guardado üíæ");
      };

      document.getElementById("autoFeedback").onclick = ()=>{
        const fb = autoReviewTop3();
        document.getElementById("top3_feedback").innerHTML = fb.html;
        document.getElementById("top3_quality").textContent = "Calidad: " + fb.label;
        toast("Revisi√≥n aplicada");
      };

      document.getElementById("resetTop3").onclick = ()=>{
        const st2 = load();
        st2.top3 = null;
        st2.lastSaved = nowISO();
        save(st2);
        initTop3();
        renderProgress();
        toast("Top 3 reiniciado ‚Ü∫");
      };

      // show stored review if exists
      document.getElementById("top3_feedback").textContent = "Completa el Top 3 y presiona ‚ÄúRevisar calidad‚Äù.";
      document.getElementById("top3_quality").textContent = "Calidad: ‚Äî";
    }

    function updateTop3Hints(i){
      const risk = document.getElementById(`r${i}_risk`).value;
      const hint = document.getElementById(`r${i}_hint`);
      if(!risk){ hint.textContent = ""; return; }
      const sugg = CONTROL_SUGGEST[risk] || [];
      hint.innerHTML = sugg.length
        ? `Sugerencias: <span style="color:rgba(255,255,255,.8)">${sugg.map(x=>escapeHtml(x)).join(" ¬∑ ")}</span>`
        : "";
    }

    function scoreTextQuality(text){
      const t = (text||"").toLowerCase();
      if(!t.trim()) return 0;
      const vague = ["tener cuidado","estar atento","ojo","precauci√≥n","vigilar","controlar bien","revisar"];
      if(vague.some(v=>t.includes(v))) return 1;
      const concrete = ["se√±al","se√±alero","segreg","aisl","bloq","loto","permiso","delimit","registro","check","checklist","foto","medir","velocidad","barr","baranda","kit","contener","ruta","canal altern","deten"];
      const hits = concrete.filter(w=>t.includes(w)).length;
      if(hits>=2) return 3;
      if(hits==1) return 2;
      return 1;
    }

    function updateRowQuality(i){
      const ctl = document.getElementById(`r${i}_control`).value;
      const ver = document.getElementById(`r${i}_verify`).value;
      const risk = document.getElementById(`r${i}_risk`).value;
      const q = document.getElementById(`q_r${i}`);
      if(!risk && !ctl && !ver){ q.textContent = "‚Äî"; return; }
      const s = scoreTextQuality(ctl) + scoreTextQuality(ver);
      if(s>=5){ q.textContent="‚úÖ Alta"; q.style.color="#8cff98"; }
      else if(s>=3){ q.textContent="‚ö†Ô∏è Media"; q.style.color="#ffd27a"; }
      else { q.textContent="‚ùå Baja"; q.style.color="#ff9b9b"; }
    }

    function autoReviewTop3(){
      const rows = [];
      let score = 0;
      for(let i=1;i<=3;i++){
        const risk = document.getElementById(`r${i}_risk`).value.trim();
        const ctl = document.getElementById(`r${i}_control`).value.trim();
        const ver = document.getElementById(`r${i}_verify`).value.trim();
        const s = scoreTextQuality(ctl) + scoreTextQuality(ver);
        score += s;
        let msg = "";
        if(!risk) msg = `<span class="bad">Falta seleccionar el riesgo.</span>`;
        else if(!ctl || !ver) msg = `<span class="warn">Completa control y verificaci√≥n.</span>`;
        else if(s>=5) msg = `<span class="ok">Bien: control y verificaci√≥n son concretos.</span>`;
        else if(s>=3) msg = `<span class="warn">Mejorable: agrega evidencia espec√≠fica (registro, observaci√≥n, check, etc.).</span>`;
        else msg = `<span class="bad">Muy general: evita ‚Äútener cuidado‚Äù. Define barrera + evidencia.</span>`;
        rows.push(`<p><b>Riesgo #${i}:</b> ${escapeHtml(risk||"‚Äî")}<br/>${msg}</p>`);
      }
      const max = 18; // 3 rows * (3+3)
      const pct = Math.round((score/max)*100);
      let label = pct>=75 ? "ALTA" : pct>=55 ? "MEDIA" : "BAJA";
      const headline = `<b>Resultado:</b> ${pct}% (calidad ${label}).`;
      const tip = `<p class="hint">Tip r√°pido: Un control de calidad suena a acci√≥n concreta + condici√≥n verificable. Ej.: ‚ÄúSegregaci√≥n de ruta + se√±alero + confirmaci√≥n por radio‚Äù.</p>`;
      return {label, html: `<div>${headline}</div><div class="divider"></div>${rows.join("")}${tip}`};
    }

    // ---------- Drag & Drop (mouse + touch) ----------
    const DD = {
      risks: [
        {id:"r_trafico", title:"Tr√°nsito interno", accept:"c_trafico"},
        {id:"r_carguio", title:"Zona de cargu√≠o", accept:"c_carguio"},
        {id:"r_fatiga", title:"Fatiga / somnolencia", accept:"c_fatiga"},
        {id:"r_loto", title:"Energ√≠as peligrosas", accept:"c_loto"}
      ],
      controls: [
        {id:"c_loto", title:"Aislar energ√≠a + permiso + liberaci√≥n formal", tip:"LOTO / PT / verificaci√≥n"},
        {id:"c_trafico", title:"Segregaci√≥n + velocidad + control en cruces", tip:"Rutas / se√±al√©tica / control"},
        {id:"c_fatiga", title:"Pausas + chequeo aptitud + rotaci√≥n", tip:"Gesti√≥n de fatiga"},
        {id:"c_carguio", title:"Zona delimitada + se√±alero + confirmaci√≥n", tip:"Entrada/salida controlada"}
      ]
    };

    function initDragDrop(){
      const st = load();
      const saved = st.dd || {placements:{}};

      const controlsWrap = document.getElementById("dd_controls");
      const zonesWrap = document.getElementById("dd_zones");
      controlsWrap.innerHTML = "";
      zonesWrap.innerHTML = "";

      // Build zones
      DD.risks.forEach(r=>{
        const dz = document.createElement("div");
        dz.className = "dropzone";
        dz.dataset.accept = r.accept;
        dz.dataset.riskid = r.id;
        dz.innerHTML = `<div>
            <div class="dz-title">üéØ ${escapeHtml(r.title)}</div>
            <div class="dz-value" id="${r.id}_val">Suelta aqu√≠ el control‚Ä¶</div>
          </div>
          <button class="btn-ghost" style="padding:6px 10px; border-radius:10px" data-clear="${r.id}">Limpiar</button>`;
        zonesWrap.appendChild(dz);
      });

      // Build controls list excluding already placed
      const placed = new Set(Object.values(saved.placements || {}));
      DD.controls.forEach(c=>{
        if(placed.has(c.id)) return;
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.draggable = true;
        chip.dataset.id = c.id;
        chip.innerHTML = `<b>${escapeHtml(c.title)}</b><small>‚†ø</small>`;
        controlsWrap.appendChild(chip);
      });

      // Apply placements
      (DD.risks||[]).forEach(r=>{
        const cid = saved.placements?.[r.id];
        if(cid){
          const c = DD.controls.find(x=>x.id===cid);
          const val = document.getElementById(r.id+"_val");
          if(val) val.textContent = c ? c.title : "‚Äî";
          const dz = [...zonesWrap.querySelectorAll(".dropzone")].find(z=>z.dataset.riskid===r.id);
          if(dz) dz.dataset.filled = "1";
        }
      });

      // Mouse DnD
      controlsWrap.addEventListener("dragstart", (e)=>{
        const chip = e.target.closest(".chip");
        if(!chip) return;
        e.dataTransfer.setData("text/plain", chip.dataset.id);
        e.dataTransfer.effectAllowed = "move";
      });
      zonesWrap.addEventListener("dragover", (e)=>{
        const dz = e.target.closest(".dropzone");
        if(!dz) return;
        e.preventDefault();
        dz.classList.add("dragover");
      });
      zonesWrap.addEventListener("dragleave", (e)=>{
        const dz = e.target.closest(".dropzone");
        if(dz) dz.classList.remove("dragover");
      });
      zonesWrap.addEventListener("drop", (e)=>{
        const dz = e.target.closest(".dropzone");
        if(!dz) return;
        e.preventDefault();
        dz.classList.remove("dragover");
        const cid = e.dataTransfer.getData("text/plain");
        placeControl(dz.dataset.riskid, cid);
      });

      // Touch / Pointer drag (clone follows finger)
      enablePointerDrag(controlsWrap, zonesWrap);

      // Clear buttons
      zonesWrap.addEventListener("click", (e)=>{
        const b = e.target.closest("[data-clear]");
        if(!b) return;
        clearPlacement(b.dataset.clear);
      });

      document.getElementById("dd_check").onclick = ()=>{
        const st2 = load();
        const placements = st2.dd?.placements || {};
        let ok = 0;
        let total = DD.risks.length;
        const wrong = [];
        DD.risks.forEach(r=>{
          const got = placements[r.id];
          if(got === r.accept) ok++;
          else wrong.push(r.title);
        });
        const fb = document.getElementById("dd_feedback");
        if(ok===total){
          fb.innerHTML = `<span class="ok"><b>‚úÖ Perfecto:</b> asignaste correctamente los ${total} controles.</span><br/><span class="hint">Traducci√≥n a turno: ya sabes pensar ‚Äúbarrera + verificaci√≥n‚Äù por tipo de riesgo.</span>`;
          toast("Juego completado üéÆ‚úÖ");
        }else{
          fb.innerHTML = `<span class="warn"><b>‚ö†Ô∏è A√∫n no:</b> ${ok}/${total} correctos.</span> Revisa: <b>${escapeHtml(wrong.join(", "))}</b>.`;
          toast("Revisa asignaciones");
        }
      };

      document.getElementById("dd_reset").onclick = ()=>{
        const st2 = load();
        st2.dd = null;
        st2.lastSaved = nowISO();
        save(st2);
        initDragDrop();
        renderProgress();
        toast("Juego reiniciado ‚Ü∫");
      };

      function placeControl(riskId, controlId){
        const st2 = load();
        st2.dd = st2.dd || {placements:{}};
        st2.dd.placements = st2.dd.placements || {};
        // If this control is already placed elsewhere, remove from there first
        for(const k of Object.keys(st2.dd.placements)){
          if(st2.dd.placements[k] === controlId){
            st2.dd.placements[k] = null;
            const v = document.getElementById(k+"_val");
            if(v) v.textContent = "Suelta aqu√≠ el control‚Ä¶";
          }
        }
        st2.dd.placements[riskId] = controlId;
        st2.lastSaved = nowISO();
        save(st2);

        const c = DD.controls.find(x=>x.id===controlId);
        const val = document.getElementById(riskId+"_val");
        if(val) val.textContent = c ? c.title : "‚Äî";

        // remove chip from list
        const chip = controlsWrap.querySelector(`.chip[data-id="${controlId}"]`);
        if(chip) chip.remove();

        renderProgress();
      }

      function clearPlacement(riskId){
        const st2 = load();
        const cid = st2.dd?.placements?.[riskId];
        if(!cid) return;
        st2.dd.placements[riskId] = null;

        // add control back to list
        const c = DD.controls.find(x=>x.id===cid);
        if(c){
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.draggable = true;
          chip.dataset.id = c.id;
          chip.innerHTML = `<b>${escapeHtml(c.title)}</b><small>‚†ø</small>`;
          controlsWrap.appendChild(chip);
        }

        const val = document.getElementById(riskId+"_val");
        if(val) val.textContent = "Suelta aqu√≠ el control‚Ä¶";
        st2.lastSaved = nowISO();
        save(st2);
        renderProgress();
        toast("Asignaci√≥n limpiada");
      }
    }

    function enablePointerDrag(controlsWrap, zonesWrap){
      let ghost = null;
      let dragId = null;
      const onDown = (e)=>{
        const chip = e.target.closest(".chip");
        if(!chip) return;
        dragId = chip.dataset.id;
        ghost = chip.cloneNode(true);
        ghost.style.position = "fixed";
        ghost.style.zIndex = "999";
        ghost.style.opacity = "0.92";
        ghost.style.pointerEvents = "none";
        ghost.style.transform = "translate(-50%, -50%) scale(1.02)";
        document.body.appendChild(ghost);
        chip.dataset.dragging = "1";
        moveGhost(e);
        try{ chip.setPointerCapture(e.pointerId); }catch{}
      };
      const moveGhost = (e)=>{
        if(!ghost) return;
        const x = e.clientX ?? (e.touches && e.touches[0].clientX);
        const y = e.clientY ?? (e.touches && e.touches[0].clientY);
        ghost.style.left = x + "px";
        ghost.style.top = y + "px";
        // highlight dropzone under pointer
        const el = document.elementFromPoint(x,y);
        zonesWrap.querySelectorAll(".dropzone").forEach(z=>z.classList.remove("dragover"));
        const dz = el && el.closest && el.closest(".dropzone");
        if(dz) dz.classList.add("dragover");
      };
      const onUp = (e)=>{
        if(!ghost) return;
        const x = e.clientX, y = e.clientY;
        const el = document.elementFromPoint(x,y);
        const dz = el && el.closest && el.closest(".dropzone");
        zonesWrap.querySelectorAll(".dropzone").forEach(z=>z.classList.remove("dragover"));
        if(dz && dragId){
          // emulate drop
          const riskId = dz.dataset.riskid;
          // place control
          const st = load();
          st.dd = st.dd || {placements:{}};
          // if already placed elsewhere remove
          for(const k of Object.keys(st.dd.placements||{})){
            if(st.dd.placements[k] === dragId){
              st.dd.placements[k] = null;
              const v = document.getElementById(k+"_val");
              if(v) v.textContent = "Suelta aqu√≠ el control‚Ä¶";
            }
          }
          st.dd.placements[riskId] = dragId;
          st.lastSaved = nowISO();
          save(st);

          const c = DD.controls.find(x=>x.id===dragId);
          const val = document.getElementById(riskId+"_val");
          if(val) val.textContent = c ? c.title : "‚Äî";

          // remove original chip
          const orig = controlsWrap.querySelector(`.chip[data-id="${dragId}"]`);
          if(orig) orig.remove();

          toast("Asignado ‚úÖ");
          renderProgress();
        }
        ghost.remove();
        ghost = null;
        dragId = null;
      };

      // pointer events
      controlsWrap.querySelectorAll(".chip").forEach(chip=>{
        chip.addEventListener("pointerdown", onDown);
        chip.addEventListener("pointermove", moveGhost);
        chip.addEventListener("pointerup", onUp);
        chip.addEventListener("pointercancel", onUp);
      });

      // Rebind after dynamic changes using MutationObserver
      const mo = new MutationObserver(()=>{
        controlsWrap.querySelectorAll(".chip").forEach(chip=>{
          if(chip.dataset.bound) return;
          chip.dataset.bound = "1";
          chip.addEventListener("pointerdown", onDown);
          chip.addEventListener("pointermove", moveGhost);
          chip.addEventListener("pointerup", onUp);
          chip.addEventListener("pointercancel", onUp);
        });
      });
      mo.observe(controlsWrap, {childList:true, subtree:true});
    }

    // ---------- STOP WORK scenarios ----------
    const SCENARIOS = [
      {
        text: "En rampa norte, un liviano ingresa a zona de tr√°nsito CAEX sin segregaci√≥n visible. Control te pide 'mantener flujo' porque hay cola.",
        choices: [
          {t:"Detener cruce, aislar zona y coordinar segregaci√≥n/ se√±alero antes de continuar.", ok:true, why:"Correcto: control cr√≠tico fall√≥ (interacci√≥n). Prioridad: seguridad y control de interferencias."},
          {t:"Permitir paso solo a los CAEX m√°s urgentes y luego ver se√±al√©tica.", ok:false, why:"Incorrecto: normaliza el riesgo. Un evento cr√≠tico no se gestiona por urgencia de producci√≥n."},
          {t:"Avisar por radio 'ojo' y continuar con precauci√≥n.", ok:false, why:"Incorrecto: 'ojo' no es barrera. Falta control concreto y verificaci√≥n."},
          {t:"Pedir al liviano que salga y continuar sin cambios.", ok:false, why:"Incorrecto: el sistema puede repetir el error. Debes asegurar barreras para todo el equipo."}
        ]
      },
      {
        text: "Mantenci√≥n solicita intervenir un CAEX 'r√°pido', pero el equipo est√° en zona operativa y no hay confirmaci√≥n de aislamiento.",
        choices: [
          {t:"Aplicar ventana coordinada + aislamiento/LOTO si aplica + liberaci√≥n formal antes de intervenir.", ok:true, why:"Correcto: energ√≠as peligrosas requieren control verificable y autorizaci√≥n."},
          {t:"Autorizar intervenci√≥n si el mec√°nico 'asegura' que ser√° r√°pido.", ok:false, why:"Incorrecto: depende de persona, no de sistema. Riesgo alto."},
          {t:"Detener solo los equipos cercanos y comenzar intervenci√≥n sin permisos.", ok:false, why:"Incorrecto: falta trazabilidad y control cr√≠tico."},
          {t:"Postergar toda mantenci√≥n hasta fin de turno siempre.", ok:false, why:"Incorrecto: decisi√≥n absoluta sin an√°lisis. Lo correcto es coordinar con control de riesgo."}
        ]
      },
      {
        text: "Se levanta viento fuerte, cae visibilidad en zona de cargu√≠o. Operadores reportan polvo y p√©rdida intermitente de radio.",
        choices: [
          {t:"Reducir/pausar operaci√≥n seg√∫n est√°ndar, definir condiciones m√≠nimas y confirmar canal alternativo.", ok:true, why:"Correcto: clima + comunicaci√≥n afectan barreras. Ajusta condiciones y verifica."},
          {t:"Aumentar velocidad para compensar p√©rdidas por detenciones.", ok:false, why:"Incorrecto: aumenta riesgo en rampas y reduce control."},
          {t:"Continuar igual y pedir 'm√°s atenci√≥n'.", ok:false, why:"Incorrecto: control vago. Falta barrera concreta (visibilidad m√≠nima / restricci√≥n)."},
          {t:"Solo registrar el evento para informe y seguir operando.", ok:false, why:"Incorrecto: registrar sin controlar no reduce riesgo."}
        ]
      },
      {
        text: "Detectas operador con signos de fatiga (respuestas lentas). Hay presi√≥n por meta. El operador dice 'estoy bien'.",
        choices: [
          {t:"Aplicar protocolo de fatiga: pausa, evaluaci√≥n, reasignaci√≥n/rotaci√≥n y registro.", ok:true, why:"Correcto: la fatiga es riesgo cr√≠tico. Debe gestionarse como sistema, no por autodeclaraci√≥n."},
          {t:"Dejarlo operar y observar 'por si acaso'.", ok:false, why:"Incorrecto: la observaci√≥n sin intervenci√≥n no es barrera suficiente."},
          {t:"Cambiarlo a una tarea m√°s r√°pida para que 'se active'.", ok:false, why:"Incorrecto: aumenta carga. Riesgo se eleva."},
          {t:"Ignorar para no afectar producci√≥n.", ok:false, why:"Incorrecto: prioriza producci√≥n sobre seguridad."}
        ]
      }
    ];

    function initScenario(){
      const st = load();
      st.sc = st.sc || {idx:0, score:0, answered:{}};
      save(st);

      document.getElementById("sc_total").textContent = SCENARIOS.length;

      const render = ()=>{
        const st2 = load();
        const idx = st2.sc?.idx ?? 0;
        const sc = SCENARIOS[idx];
        document.getElementById("sc_idx").textContent = (idx+1);
        document.getElementById("sc_score").textContent = st2.sc?.score ?? 0;
        document.getElementById("sc_text").textContent = sc.text;

        const box = document.getElementById("sc_choices");
        box.innerHTML = "";
        const answered = st2.sc?.answered?.[idx];
        sc.choices.forEach((c,ci)=>{
          const d = document.createElement("div");
          d.className = "choice";
          d.textContent = c.t;
          if(answered!=null){
            d.classList.add(c.ok ? "correct" : (ci===answered ? "incorrect" : ""));
          }
          d.onclick = ()=>{
            const st3 = load();
            st3.sc = st3.sc || {idx:idx, score:0, answered:{}};
            if(st3.sc.answered[idx]!=null){
              toast("Ya respondiste este escenario");
              return;
            }
            st3.sc.answered[idx] = ci;
            if(c.ok) st3.sc.score = (st3.sc.score||0) + 1;
            st3.lastSaved = nowISO();
            save(st3);
            document.getElementById("sc_explain").innerHTML = (c.ok ? `<span class="ok"><b>‚úÖ Correcto:</b> ${escapeHtml(c.why)}</span>` : `<span class="bad"><b>‚ùå Incorrecto:</b> ${escapeHtml(c.why)}</span>`);
            render();
          };
          box.appendChild(d);
        });

        if(answered!=null){
          const chosen = sc.choices[answered];
          document.getElementById("sc_explain").innerHTML = (chosen.ok ? `<span class="ok"><b>‚úÖ Correcto:</b> ${escapeHtml(chosen.why)}</span>` : `<span class="bad"><b>‚ùå Incorrecto:</b> ${escapeHtml(chosen.why)}</span>`);
        }else{
          document.getElementById("sc_explain").textContent = "Selecciona una acci√≥n. Tu meta es decidir r√°pido y bien.";
        }
      };

      document.getElementById("sc_next").onclick = ()=>{
        const st2 = load();
        st2.sc = st2.sc || {idx:0, score:0, answered:{}};
        st2.sc.idx = (st2.sc.idx + 1) % SCENARIOS.length;
        st2.lastSaved = nowISO();
        save(st2);
        render();
      };
      document.getElementById("sc_reset").onclick = ()=>{
        const st2 = load();
        st2.sc = {idx:0, score:0, answered:{}};
        st2.lastSaved = nowISO();
        save(st2);
        render();
        renderProgress();
        toast("Simulador reiniciado ‚Ü∫");
      };

      render();
    }

    // ---------- Activities ----------
    function initActivities(){
      const st = load();
      if(st.act1) document.getElementById("act1").value = st.act1;
      if(st.act2){
        document.getElementById("act2_control").value = st.act2.control || "";
        document.getElementById("act2_evidence").value = st.act2.evidence || "";
      }
      if(st.act3){
        document.getElementById("act3_event").value = st.act3.event || "";
        document.getElementById("act3_action").value = st.act3.action || "";
      }
      document.getElementById("act1_state").textContent = st.act1 ? "Guardado ‚úÖ" : "Sin guardar";
      document.getElementById("act2_state").textContent = st.act2 ? "Guardado ‚úÖ" : "Sin guardar";
      document.getElementById("act3_state").textContent = st.act3 ? "Guardado ‚úÖ" : "Sin guardar";

      document.getElementById("saveAct1").onclick = ()=>{
        const st2 = load();
        st2.act1 = document.getElementById("act1").value;
        st2.lastSaved = nowISO();
        save(st2);
        document.getElementById("act1_state").textContent = "Guardado ‚úÖ";
        renderProgress();
        toast("Actividad 1 guardada");
      };
      document.getElementById("copyAct1").onclick = async ()=>{
        await navigator.clipboard.writeText(document.getElementById("act1").value || "");
        toast("Copiado al portapapeles");
      };
      document.getElementById("saveAct2").onclick = ()=>{
        const st2 = load();
        st2.act2 = {
          control: document.getElementById("act2_control").value,
          evidence: document.getElementById("act2_evidence").value
        };
        st2.lastSaved = nowISO();
        save(st2);
        document.getElementById("act2_state").textContent = "Guardado ‚úÖ";
        renderProgress();
        toast("Actividad 2 guardada");
      };
      document.getElementById("saveAct3").onclick = ()=>{
        const st2 = load();
        st2.act3 = {
          event: document.getElementById("act3_event").value,
          action: document.getElementById("act3_action").value
        };
        st2.lastSaved = nowISO();
        save(st2);
        document.getElementById("act3_state").textContent = "Guardado ‚úÖ";
        renderProgress();
        toast("Actividad 3 guardada");
      };
    }

    // ---------- Quiz ----------
    const QUIZ = [
      {
        q:"¬øCu√°l frase describe mejor ‚Äúcontrol del riesgo‚Äù en turno?",
        opts:["Tener cuidado y experiencia", "Barreras concretas + verificaci√≥n + acci√≥n si falla", "Hacer m√°s r√°pido el trabajo", "Depende del SSO solamente"],
        a:1,
        why:"Control del riesgo = barreras (controles) concretas, verificables y con acci√≥n si fallan."
      },
      {
        q:"Un control ‚Äòvago‚Äô (d√©bil) es‚Ä¶",
        opts:["Se√±alero en cruce + registro", "Segregaci√≥n de rutas", "‚ÄòOjo y est√©n atentos‚Äô", "Checklist preoperacional"],
        a:2,
        why:"‚ÄúOjo‚Äù no es una barrera. No es verificable y depende de la voluntad."
      },
      {
        q:"¬øQu√© completa correctamente el ciclo: Riesgo ‚Üí Control ‚Üí ____ ?",
        opts:["Producci√≥n", "Verificaci√≥n (evidencia)", "Opini√≥n", "Motivaci√≥n"],
        a:1,
        why:"Sin verificaci√≥n, el control se vuelve suposici√≥n."
      },
      {
        q:"Si un control cr√≠tico falla (ej.: no hay se√±alero en cruce), la prioridad es‚Ä¶",
        opts:["Seguir para no atrasar", "STOP WORK o restricci√≥n hasta restablecer barrera", "Solo informar al final del turno", "Rezar que no pase nada"],
        a:1,
        why:"Cuando falla una barrera cr√≠tica, se restringe o detiene hasta restaurar control."
      },
      {
        q:"En coordinaci√≥n con Mantenci√≥n, la opci√≥n correcta es‚Ä¶",
        opts:["Intervenir r√°pido sin permisos", "Ventana + aislamiento/permiso + liberaci√≥n formal", "Hacerlo cuando puedan", "Pedir al mec√°nico que se cuide"],
        a:1,
        why:"Coordinar = sincronizar + controlar energ√≠as + trazabilidad."
      },
      {
        q:"La verificaci√≥n ‚Äòbuena‚Äô se reconoce porque‚Ä¶",
        opts:["Es corta", "Se puede observar/medir/registrar", "No requiere evidencia", "Depende de memoria"],
        a:1,
        why:"Evidencia observable: checklist, foto, medici√≥n, registro, observaci√≥n directa."
      },
      {
        q:"Fatiga en conducci√≥n es un riesgo porque‚Ä¶",
        opts:["Baja la atenci√≥n y aumenta error cr√≠tico", "Aumenta la producci√≥n", "No influye en seguridad", "Se soluciona con caf√©"],
        a:0,
        why:"Fatiga afecta tiempos de reacci√≥n y toma de decisiones. Requiere gesti√≥n sistem√°tica."
      },
      {
        q:"Bajo presi√≥n, el m√©todo recomendado es‚Ä¶",
        opts:["Acelerar", "Pausa‚ÄìPiensa‚ÄìAct√∫a", "Gritar para ordenar", "Improvisar"],
        a:1,
        why:"Pausa‚ÄìPiensa‚ÄìAct√∫a reduce impulsividad y mejora decisiones."
      },
      {
        q:"¬øQu√© indicador refleja mala coordinaci√≥n y riesgo en zona de cargu√≠o?",
        opts:["Colas/esperas y radios saturadas sin confirmaci√≥n", "M√∫sica en cabina", "Color del casco", "Temperatura ambiente"],
        a:0,
        why:"Colas + comunicaci√≥n pobre aumentan interferencias y exposici√≥n."
      },
      {
        q:"El control del riesgo ‚Äòdel equipo‚Äô significa que‚Ä¶",
        opts:["Solo el supervisor decide", "Cualquiera puede detener y verificar controles cr√≠ticos", "Solo Control/Despacho manda", "Solo SSO revisa"],
        a:1,
        why:"La robustez aumenta cuando el equipo comparte verificaci√≥n y derecho a detener por seguridad."
      },
      {
        q:"En clima extremo con baja visibilidad, lo correcto es‚Ä¶",
        opts:["Seguir igual", "Definir condiciones m√≠nimas y ajustar/pausar", "Aumentar velocidad", "Quitar controles para recuperar producci√≥n"],
        a:1,
        why:"Visibilidad afecta barreras. Se ajusta operaci√≥n seg√∫n est√°ndar y se verifica."
      },
      {
        q:"¬øQu√© acci√≥n deja trazabilidad operativa real?",
        opts:["Decir ‚Äòlo vi‚Äô", "Registrar evento + acci√≥n + responsable", "Solo comentar en pasillo", "Esperar que pase"],
        a:1,
        why:"Trazabilidad = registro de decisi√≥n y acci√≥n (qu√©, qui√©n, cu√°ndo)."
      }
    ];

    function initQuiz(){
      const st = load();
      st.quiz = st.quiz || {idx:0, answers:Array(QUIZ.length).fill(null), score:0, best:null};
      save(st);

      document.getElementById("q_total").textContent = QUIZ.length;
      document.getElementById("q_best").textContent = st.quiz.best==null ? "‚Äî" : (st.quiz.best + "/" + QUIZ.length);

      const render = ()=>{
        const st2 = load();
        const qz = st2.quiz;
        const idx = qz.idx || 0;
        document.getElementById("q_idx").textContent = (idx+1);
        document.getElementById("q_score").textContent = qz.score || 0;

        const item = QUIZ[idx];
        document.getElementById("q_text").textContent = item.q;
        const box = document.getElementById("q_opts");
        box.innerHTML = "";

        const chosen = qz.answers[idx];
        item.opts.forEach((t, oi)=>{
          const d = document.createElement("div");
          d.className = "opt";
          d.textContent = t;
          if(chosen===oi) d.classList.add("selected");
          // show correctness if already answered
          if(chosen!=null){
            if(oi===item.a) d.classList.add("correct");
            else if(oi===chosen) d.classList.add("incorrect");
          }
          d.onclick = ()=>{
            const st3 = load();
            st3.quiz = st3.quiz || {idx:idx, answers:Array(QUIZ.length).fill(null), score:0, best:null};
            if(st3.quiz.answers[idx]!=null){
              toast("Ya respondiste esta pregunta (reinicia si quieres repetir)");
              return;
            }
            st3.quiz.answers[idx] = oi;
            if(oi===item.a) st3.quiz.score = (st3.quiz.score||0) + 1;
            st3.lastSaved = nowISO();
            save(st3);
            document.getElementById("q_explain").innerHTML =
              (oi===item.a)
                ? `<span class="ok"><b>‚úÖ Correcto:</b> ${escapeHtml(item.why)}</span>`
                : `<span class="bad"><b>‚ùå Incorrecto:</b> ${escapeHtml(item.why)}</span>`;
            render();
          };
          box.appendChild(d);
        });

        if(chosen!=null){
          document.getElementById("q_explain").innerHTML =
            (chosen===item.a)
              ? `<span class="ok"><b>‚úÖ Correcto:</b> ${escapeHtml(item.why)}</span>`
              : `<span class="bad"><b>‚ùå Incorrecto:</b> ${escapeHtml(item.why)}</span>`;
        }else{
          document.getElementById("q_explain").textContent = "Selecciona una alternativa para ver retroalimentaci√≥n.";
        }

        document.getElementById("q_best").textContent = st2.quiz.best==null ? "‚Äî" : (st2.quiz.best + "/" + QUIZ.length);
      };

      document.getElementById("q_prev").onclick = ()=>{
        const st2 = load();
        st2.quiz.idx = Math.max(0, (st2.quiz.idx||0) - 1);
        st2.lastSaved = nowISO();
        save(st2);
        render();
      };
      document.getElementById("q_next").onclick = ()=>{
        const st2 = load();
        st2.quiz.idx = Math.min(QUIZ.length-1, (st2.quiz.idx||0) + 1);
        st2.lastSaved = nowISO();
        save(st2);
        render();
      };
      document.getElementById("q_finish").onclick = ()=>{
        const st2 = load();
        const answered = st2.quiz.answers.filter(x=>x!=null).length;
        const score = st2.quiz.score || 0;
        const pct = Math.round((score/QUIZ.length)*100);
        if(answered < QUIZ.length){
          toast("A√∫n faltan preguntas por responder");
          document.getElementById("q_explain").innerHTML =
            `<span class="warn"><b>Faltan ${QUIZ.length-answered}</b> preguntas. Completa todo para cerrar.</span>`;
          return;
        }
        st2.quiz.best = Math.max(st2.quiz.best||0, score);
        st2.lastSaved = nowISO();
        save(st2);
        const msg = pct>=80
          ? `<span class="ok"><b>‚úÖ Excelente:</b> ${score}/${QUIZ.length} (${pct}%). Listo para aplicar en turno.</span>`
          : `<span class="warn"><b>‚ö†Ô∏è A reforzar:</b> ${score}/${QUIZ.length} (${pct}%). Repite el juego y escenarios.</span>`;
        document.getElementById("q_explain").innerHTML = msg + `<div class="divider"></div><span class="hint">Recomendaci√≥n: vuelve a ‚ÄúTop 3‚Äù y escribe controles verificables.</span>`;
        render();
        toast("Quiz finalizado");
      };
      document.getElementById("q_reset").onclick = ()=>{
        const st2 = load();
        st2.quiz = {idx:0, answers:Array(QUIZ.length).fill(null), score:0, best: st2.quiz?.best ?? null};
        st2.lastSaved = nowISO();
        save(st2);
        render();
        renderProgress();
        toast("Quiz reiniciado ‚Ü∫");
      };

      render();
    }

    // ---------- Reflection ----------
    function initReflection(){
      const st = load();
      if(st.reflection) document.getElementById("reflection").value = st.reflection;
      document.getElementById("ref_state").textContent = st.reflection ? "Guardado ‚úÖ" : "Sin guardar";

      document.getElementById("saveReflection").onclick = ()=>{
        const st2 = load();
        st2.reflection = document.getElementById("reflection").value;
        st2.lastSaved = nowISO();
        save(st2);
        document.getElementById("ref_state").textContent = "Guardado ‚úÖ";
        renderProgress();
        toast("Reflexi√≥n guardada");
      };
      document.getElementById("copyReflection").onclick = async ()=>{
        await navigator.clipboard.writeText(document.getElementById("reflection").value || "");
        toast("Copiado al portapapeles");
      };
    }

    // ---------- Quick tools ----------
    const CHECKLIST = `CHECKLIST ¬∑ Control del Riesgo en Equipo (M√≥dulo 8)
1) Meta del turno (1 frase) definida y compartida.
2) Top 3 riesgos del turno definidos con:
   - Control (barrera concreta)
   - Verificaci√≥n (evidencia)
   - Acci√≥n si falla (escalamiento / STOP WORK)
3) Barreras cr√≠ticas verificadas en terreno (no asumidas).
4) Reglas de STOP WORK claras (qui√©n detiene, c√≥mo se comunica).
5) Coordinaci√≥n con Control/Mantenci√≥n/SSO para ventanas cr√≠ticas.
6) Cierre: lecci√≥n aprendida + pendiente cr√≠tico + traspaso formal.`;

    const SBAR = `FORMATO SBAR (mensaje operativo por radio)
S (Situaci√≥n): ¬øQu√© pasa ahora?
B (Background): Contexto m√≠nimo (d√≥nde/desde cu√°ndo).
A (Acci√≥n): Qu√© har√°s o ya hiciste (control instalado).
R (Requerimiento): Qu√© necesitas del otro (Control/SSO/Mantenci√≥n).

Ejemplo:
‚ÄúControl, situaci√≥n: cruce norte sin se√±alero y liviano ingres√≥.
Contexto: visibilidad baja por polvo.
Acci√≥n: restrinjo cruce y desv√≠o ruta.
Requiero: apoyo de se√±alero y registrar restricci√≥n.‚Äù`;

    document.getElementById("copyChecklist").onclick = async ()=>{
      await navigator.clipboard.writeText(CHECKLIST);
      toast("Checklist copiado üìã");
    };
    document.getElementById("copySBAR").onclick = async ()=>{
      await navigator.clipboard.writeText(SBAR);
      toast("SBAR copiado üìª");
    };

    document.getElementById("resetAll").onclick = ()=>{
      if(!confirm("Esto borrar√° TODO el progreso guardado de este m√≥dulo en este dispositivo. ¬øContinuar?")) return;
      localStorage.removeItem(KEY);
      location.reload();
    };

    // ---------- Utilities ----------
    function escapeHtml(s){
      return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    // ---------- Boot ----------
    function boot(){
      // Ensure structure exists
      const st = load();
      st.completed = st.completed || [];
      save(st);

      initTop3();
      initDragDrop();
      initScenario();
      initActivities();
      initQuiz();
      initReflection();
      renderProgress();
    }
    window.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
