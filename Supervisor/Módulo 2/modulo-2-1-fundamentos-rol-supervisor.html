<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Anupro360 · Módulo 2.1 Fundamentos y Rol del Supervisor</title>
  <meta name="description" content="Microaprendizaje dinámico: Seguridad Operacional y Salud Ocupacional (Anupro360) · Módulo 2.1">
  <style>
    :root{
      --amarillo:#FFB81C; /* Amarillo Minero */
      --naranja:#FF5C00;  /* Naranja */
      --gris:#5C6B6B;     /* Gris Acero */
      --verde:#4B6F44;    /* Verde Mineral */
      --azul:#003B5C;     /* Azul Oscuro */
      --blanco:#FFFFFF;   /* Blanco */
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; background:linear-gradient(180deg,var(--azul) 0%, #072A3D 100%); color:var(--blanco); -webkit-font-smoothing:antialiased}
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px); background:rgba(0,59,92,.75); border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:1080px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{width:42px; height:42px; border-radius:12px; object-fit:contain}
    h1{font-size:1.2rem; margin:0}
    .chip{font-size:.75rem; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15); padding:4px 8px; border-radius:999px}

    .hero{border-bottom:1px solid rgba(255,255,255,.08); background: radial-gradient(900px 220px at 50% -40%, rgba(255,184,28,.2), transparent), radial-gradient(800px 280px at 100% 0%, rgba(255,92,0,.15), transparent)}
    .hero h2{margin:.25rem 0 .5rem; font-size:1.4rem}
    .progress{height:10px; width:100%; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--amarillo),var(--naranja)); transition:width .4s ease}

    .grid{display:grid; gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.25fr .75fr}}

    .card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h3{margin-top:0}
    .note{font-size:.92rem; opacity:.9}

    .btn, .btn-ghost, .btn-sec{cursor:pointer; border:none; border-radius:12px; padding:10px 14px; font-weight:600}
    .btn{background:linear-gradient(180deg,var(--amarillo),#EAA20F); color:#0b1116; box-shadow:0 6px 16px rgba(255,184,28,.35)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent; color:var(--blanco); border:1px solid rgba(255,255,255,.2); text-decoration:none; display:inline-block}
    .btn-sec{background:linear-gradient(180deg,var(--verde),#375636); color:#fff}

    details{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px}
    details>summary{cursor:pointer; font-weight:700}

    ul.bullet{margin:8px 0 0 18px; line-height:1.6}
    .pill{display:flex; gap:10px; align-items:center; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.12); padding:12px; border-radius:12px}

    .two{display:grid; gap:12px}
    @media(min-width:780px){.two{grid-template-columns:1fr 1fr}}

    textarea{width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.2); color:var(--blanco)}

    /* DRAG & DROP */
    .bank, .dropzone{display:flex; gap:8px; flex-wrap:wrap; padding:10px; border-radius:12px; border:1px dashed rgba(255,255,255,.2); background:rgba(255,255,255,.04); min-height:56px}
    .token{user-select:none; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.24); cursor:grab; font-weight:600}
    .token.dragging{opacity:.6}
    .drop{background:rgba(0,0,0,.22)}
    .dz-ok{border-color: rgba(75,111,68,.9); background: rgba(75,111,68,.08)}
    .dz-bad{border-color: rgba(255,92,0,.9); background: rgba(255,92,0,.08)}
    .token.lock{cursor:not-allowed; background:rgba(75,111,68,.25); border-color:#4B6F44}

    /* SORTABLE */
    .sortable{display:flex; flex-direction:column; gap:8px}
    .item{padding:10px; border-radius:10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); cursor:grab}
    .item.ghost{opacity:.5; border-style:dashed}
    .ok{outline:2px solid #4B6F44}

    /* Quiz */
    .q{padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); margin-bottom:10px}
    .opt{display:flex; gap:8px; align-items:flex-start; margin:6px 0}
    .q.correct{border-color: rgba(75,111,68,.9); background: rgba(75,111,68,.08)}
    .q.wrong{border-color: rgba(255,92,0,.9); background: rgba(255,92,0,.08)}
    .opt.correct{outline:2px solid #4B6F44; border-radius:8px; padding:4px}
    .opt.wrong{outline:2px solid #FF5C00; border-radius:8px; padding:4px}

    footer{opacity:.75; font-size:.85rem; padding:24px 0}
    .small{font-size:.85rem; opacity:.9}
    .tag{font-size:.72rem; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06)}
  </style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
    <div class="brand">
      <!-- IMAGEN: imagotipo en blanco | nombre sugerido: imagotipoblanco.webp -->
      <img src="imagotipoblanco.webp" alt="Anupro360">
      <h1>Anupro360 · Módulo 2.1 · Fundamentos y Rol del Supervisor</h1>
    </div>
    <div class="chip" id="badge">Progreso 0%</div>
  </div>
</header>

<section class="hero">
  <div class="wrap">
    <h2>Gestionar la Seguridad Operacional y la Salud Ocupacional</h2>
    <p class="note"><strong>Aprendizaje esperado:</strong> Comprender el rol del supervisor/a en SST, el marco normativo base, y aplicar hábitos diarios que previenen incidentes.</p>
    <div class="progress" aria-label="Progreso del módulo"><i id="bar"></i></div>
  </div>
</section>

<main class="wrap grid" id="app" role="main">
  <!-- Columna izquierda -->
  <section class="card">
    <h3>1) Introducción y objetivo</h3>
    <details open>
      <summary>¿Por qué tu rol es decisivo?</summary>
      <p>El/la supervisor/a es el <strong>punto de encuentro</strong> entre la estrategia de la compañía y el trabajo real en terreno. Su influencia en seguridad es directa: <em>lo que valida, refuerza y corrige</em> determina el estándar del equipo. La prioridad es innegociable: <strong>“Nadie se lesiona.”</strong></p>
      <p>El rol se resume en tres pilares: <strong>Modelo</strong> (liderazgo visible), <strong>Gestor</strong> (planifica y verifica) y <strong>Protector</strong> (prioriza la vida sobre la producción). Tu presencia activa en terreno, la calidad de tus conversaciones y el uso disciplinado de herramientas preventivas son los mayores multiplicadores de seguridad.</p>
    </details>
    <div class="pill" style="margin-top:10px">
      <div style="width:10px; height:10px; border-radius:50%; background:var(--amarillo)"></div>
      <div><strong>Idea clave:</strong> si una tarea no es segura, se <strong>detiene</strong> y se <strong>replantea</strong>. La producción nunca está por sobre la vida.</div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" data-complete="intro">Marcar leído ✓</button>
    </div>
    <!-- IMAGEN: héroe del módulo (supervisor/a en terreno) | nombre: mod2_1_hero_supervisor.webp -->
    <img src="mod2_1_hero_supervisor.webp" alt="Supervisor/a en terreno liderando charla breve" style="width:100%; margin-top:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12)">
    <p class="small"> <em></em> · </p>
  </section>

  <!-- Columna derecha -->
  <aside class="card">
    <h3>Ficha del Micro-módulo 2.1</h3>
    <ul class="bullet">
      <li>Tiempo estimado: <strong>15–20 min</strong></li>
      <li>Formato: lectura guiada + arrastrar y soltar + ordenar + quiz</li>
      <li>Objetivo: clarificar <em>rol</em>, <em>normativa base</em> y <em>hábitos diarios</em></li>
    </ul>
    <hr style="border-color:rgba(255,255,255,.12)">
    <button class="btn-ghost" id="reset">Reiniciar progreso</button>
  </aside>

  <!-- Rol del Supervisor -->
  <section class="card">
    <h3>2) Tu rol: Modelo · Gestor · Protector</h3>
    <div class="two">
      <div>
        <p><strong>Modelo (Liderazgo visible):</strong> estar en terreno, observar, escuchar y reforzar <em>conductas seguras</em>. Tu equipo replica lo que validas. Un saludo, una pregunta abierta o una corrección oportuna pueden evitar un incidente mayor.</p>
        <p><strong>Gestor:</strong> organiza recursos, comunica riesgos y verifica controles críticos. El uso disciplinado de HPT/ART/PTS, permisos y bitácora es parte del trabajo, no un trámite.</p>
        <p><strong>Protector:</strong> decide <em>parar</em> cuando los controles no están garantizados. “Mejor un minuto detenido que una vida perdida”.</p>
      </div>
      <div class="pill">
        <div style="width:10px; height:10px; border-radius:50%; background:var(--naranja)"></div>
        <div><strong>Aplicación inmediata:</strong> incorpora al inicio del turno una <em>charla de 5’</em> (1 riesgo crítico + 1 control + 1 conducta esperada) y deja evidencia en la bitácora.</div>
      </div>
    </div>
    <!-- IMAGEN: liderazgo visible | nombre: mod2_1_liderazgo_visible.webp -->
    <img src="mod2_1_liderazgo_visible.webp" alt="Liderazgo visible en recorrido de seguridad" style="width:100%; margin-top:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12)">
    <p class="small"> <em></em> · </p>
    <div style="margin-top:10px"><button class="btn" data-complete="rol">He comprendido mi rol ✓</button></div>
  </section>

  <!-- Normativa base -->
  <section class="card">
    <h3>3) Normativa base (recordatorio)</h3>
    <details open>
      <summary>Ley 16.744 y reglamentos internos</summary>
      <p>La Ley 16.744 regula accidentes del trabajo y enfermedades profesionales e impulsa la <strong>prevención</strong> como deber de todos. En faena, además rigen <em>reglamentos internos</em>, procedimientos y permisos que definen estándares mínimos y responsabilidades. No memorices todo: <strong>domina</strong> lo que aplicas a diario y <strong>consulta</strong> cuando sea necesario.</p>
    </details>
    <details>
      <summary>Tres hábitos diarios</summary>
      <ul class="bullet">
        <li><strong>Charla de 5’:</strong> riesgo crítico del día + control + conducta esperada.</li>
        <li><strong>Verificación de controles críticos:</strong> si no están, <em>no se ejecuta</em>.</li>
        <li><strong>Registro simple:</strong> hallazgos, correcciones y acuerdos en bitácora.</li>
      </ul>
    </details>
    <!-- IMAGEN: controles críticos | nombre: mod2_1_controles_criticos_diagrama.webp -->
    <img src="mod2_1_controles_criticos_diagrama.webp" alt="Esquema de controles críticos" style="width:100%; margin-top:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12)">
    <p class="small"> <em></em> · </p>
    <div style="margin-top:10px"><button class="btn" data-complete="normativa">He revisado la normativa ✓</button></div>
  </section>

  <!-- Actividad 1: Emparejar término-definición -->
  <section class="card">
    <h3>4) Actividad: Empareja término y definición</h3>
    <p class="note">Arrastra cada <strong>definición</strong> desde el “Banco” a la <strong>tarjeta del término</strong> correcto. Verde = correcto · Rojo = incorrecto.</p>
    <div class="two" id="match">
      <div>
        <div class="tag">Banco</div>
        <div class="bank" id="bank1" aria-label="Banco de definiciones">
          <div class="token" draggable="true" data-key="peligro">Fuente o situación con <em>potencial</em> de causar daño.</div>
          <div class="token" draggable="true" data-key="riesgo">Combinación de <em>probabilidad</em> y <em>consecuencia</em> de un evento.</div>
          <div class="token" draggable="true" data-key="control">Barrera o medida que evita/mitiga eventos graves.</div>
          <div class="token" draggable="true" data-key="liderazgo">Presencia activa en terreno para <em>verificar, escuchar y reforzar</em> seguridad.</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
          <button class="btn-ghost" id="resetMatch1">Reiniciar</button>
        </div>
      </div>
      <div>
        <div class="dropzone" data-accept="peligro"><strong>Peligro</strong></div>
        <div class="dropzone" data-accept="riesgo" style="margin-top:8px"><strong>Riesgo</strong></div>
        <div class="dropzone" data-accept="control" style="margin-top:8px"><strong>Control crítico</strong></div>
        <div class="dropzone" data-accept="liderazgo" style="margin-top:8px"><strong>Liderazgo visible</strong></div>
      </div>
    </div>
    <p id="match1Msg" class="small" style="margin-top:8px"></p>
  </section>

  <!-- Actividad 2: Ordena el ciclo diario -->
  <section class="card">
    <h3>5) Actividad: Ordena el ciclo diario de seguridad</h3>
    <p class="note">Arrastra los pasos para ordenarlos correctamente: <strong>Charla 5’ → Verificar controles críticos → Ejecutar → Registrar en bitácora → Cierre de turno</strong>.</p>
    <div class="sortable" id="orden">
      <div class="item" draggable="true" data-id="ejecutar">Ejecutar tarea bajo controles validados</div>
      <div class="item" draggable="true" data-id="charla">Charla de 5’ (riesgo, control, conducta)</div>
      <div class="item" draggable="true" data-id="registro">Registrar hallazgos, correcciones y acuerdos</div>
      <div class="item" draggable="true" data-id="cierre">Cierre del turno (bitácora final y lección)</div>
      <div class="item" draggable="true" data-id="verificar">Verificar controles críticos (antes de iniciar)</div>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
      <button class="btn-sec" id="checkOrden">Comprobar</button>
      <button class="btn-ghost" id="resetOrden">Reiniciar</button>
    </div>
    <p id="ordenMsg" class="small"></p>
  </section>

  <!-- Actividad 3: Escenario → Acción -->
  <section class="card">
    <h3>6) Actividad: ¿Qué harías en cada escenario?</h3>
    <p class="note">Arrastra cada <strong>escenario</strong> al contenedor de la <strong>acción</strong> correcta.</p>
    <div class="two" id="esc">
      <div>
        <div class="tag">Escenarios</div>
        <div class="bank" id="bank2">
          <div class="token" draggable="true" data-key="detener">Falla de freno en preuso sin reemplazo disponible.</div>
          <div class="token" draggable="true" data-key="ajustar">Cambio de ruta por meteorología, controles disponibles.</div>
          <div class="token" draggable="true" data-key="consultar">Duda sobre permiso requerido para trabajo en altura.</div>
        </div>
      </div>
      <div>
        <div class="dropzone" data-accept="detener"><strong>Detener y replantear</strong></div>
        <div class="dropzone" data-accept="ajustar" style="margin-top:8px"><strong>Ajustar y comunicar</strong></div>
        <div class="dropzone" data-accept="consultar" style="margin-top:8px"><strong>Consultar y verificar</strong></div>
      </div>
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
      <button class="btn-ghost" id="resetMatch2">Reiniciar</button>
    </div>
    <p id="match2Msg" class="small"></p>
  </section>

  <!-- Glosario + Bitácora -->
  <section class="card">
    <h3>7) Glosario y bitácora</h3>
    <div class="two">
      <div>
        <ul class="bullet">
          <li><strong>Peligro:</strong> fuente con potencial de daño (energía, sustancias, altura, atrapamiento).</li>
          <li><strong>Riesgo:</strong> probabilidad x consecuencia de que ocurra un evento.</li>
          <li><strong>Control crítico:</strong> barrera indispensable para prevenir eventos graves/fatales.</li>
          <li><strong>Liderazgo visible:</strong> presencia activa en terreno para observar, escuchar y reforzar.</li>
        </ul>
      </div>
      <div>
        <!-- IMAGEN: mockup de bitácora | nombre: mod2_1_bitacora_mockup.webp -->
        <img src="mod2_1_bitacora_mockup.webp" alt="Ejemplo de bitácora simple" style="width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.12)">
        <p class="small"> <em></em> · </p>
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn" data-complete="glosario">He revisado el glosario ✓</button></div>
  </section>

  <!-- Checklist -->
  <section class="card">
    <h3>8) Checklist 1 minuto</h3>
    <div class="two">
      <div>
        <label class="pill"><input type="checkbox" class="ck"> ¿Informé el riesgo crítico del día?</label>
        <label class="pill"><input type="checkbox" class="ck"> ¿Verifiqué los controles críticos antes de iniciar?</label>
        <label class="pill"><input type="checkbox" class="ck"> ¿Registré hallazgos y acciones en bitácora?</label>
      </div>
      <div>
        <p class="note">Cuando actives las tres casillas, se marcará esta sección como completada.</p>
        <div id="ckMsg" class="small"></div>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <section class="card">
    <h3>9) Mini-quiz (10 preguntas)</h3>
    <div id="quiz"></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn-sec" id="enviar">Enviar respuestas</button>
      <button class="btn-ghost" id="resetQuiz">Reiniciar quiz</button>
    </div>
    <div id="quizFeedback" class="note" aria-live="polite" style="margin-top:8px"></div>
    <button class="btn" data-complete="quiz" style="margin-top:8px">Marcar quiz como completado ✓</button>
  </section>

  <!-- Reflexión -->
  <section class="card">
    <h3>10) Reflexión final (2 líneas)</h3>
    <textarea id="reflexion" rows="3" placeholder="¿Qué cambio aplicarás esta semana para reforzar tu liderazgo visible?"></textarea>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="btn-ghost" id="guardarRef">Guardar</button>
      <button class="btn-ghost" id="copiarRef">Copiar para Classroom</button>
    </div>
    <p class="small">Nota: se guarda sólo en este dispositivo.</p>
  </section>
</main>

<footer class="wrap">
  <div>© <span id="year"></span> Anupro360 · Colores corporativos aplicados.</div>
</footer>

<script>
  /* Utilidades */
  const $ = (s,d=document)=>d.querySelector(s);
  const $$ = (s,d=document)=>Array.from(d.querySelectorAll(s));
  const store = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const read  = (k,def=null)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? def}catch(e){return def} };

  const state = read('anupro360_m2_1', {
    done:{intro:false,rol:false,normativa:false,glosario:false,act1:false,act2:false,act3:false,check:false,quiz:false},
    reflexion:''
  });

  function calcProgress(){
    const total = Object.values(state.done).length;
    const ok = Object.values(state.done).filter(Boolean).length;
    const pct = Math.round(ok/total*100);
    $('#bar').style.width = pct+'%';
    $('#badge').textContent = `Progreso ${pct}%`;
  }
  $$('button[data-complete]').forEach(b=>{
    b.addEventListener('click', e=>{
      const key = e.currentTarget.dataset.complete;
      state.done[key] = true; store('anupro360_m2_1', state); calcProgress();
      e.currentTarget.textContent='Completado ✓'; e.currentTarget.disabled=true; e.currentTarget.classList.add('btn-ghost');
    })
  });
  $('#reset')?.addEventListener('click', ()=>{ localStorage.removeItem('anupro360_m2_1'); location.reload(); });

  /* ---------- Actividad 1: Emparejar término-definición ---------- */
  function ddSetup(containerSelector){
    let dragging=null;
    $$(containerSelector+' .token').forEach(tok=>{
      tok.addEventListener('dragstart', ()=>{ dragging=tok; tok.classList.add('dragging'); });
      tok.addEventListener('dragend', ()=>{ dragging=null; tok.classList.remove('dragging'); });
      // soporte táctil simple: tap mueve al último dropzone seleccionado
      tok.addEventListener('click', ()=>{
        const target = document.activeDropzone || null;
        if(target) tryDrop(target, tok);
      });
    });
    $$(containerSelector+' .dropzone, '+containerSelector+' .bank').forEach(zone=>{
      zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('drop'); document.activeDropzone = zone; });
      zone.addEventListener('dragleave', ()=> zone.classList.remove('drop'));
      zone.addEventListener('drop', (e)=>{ e.preventDefault(); zone.classList.remove('drop'); if(dragging) tryDrop(zone, dragging); });
      zone.addEventListener('click', ()=>{ document.activeDropzone = zone; });
    });
  }
  function tryDrop(zone, tok){
    if(zone.classList.contains('bank')){
      // devolver al banco
      tok.classList.remove('lock'); zone.appendChild(tok);
      zone.classList.remove('dz-ok','dz-bad');
      return;
    }
    const accept = zone.dataset.accept;
    const key = tok.dataset.key;
    // limpiar token previo si lo hay
    const prev = zone.querySelector('.token');
    if(prev){ $('#bank1').appendChild(prev); prev.classList.remove('lock'); }
    zone.appendChild(tok);
    if(accept===key){
      zone.classList.add('dz-ok'); zone.classList.remove('dz-bad');
      tok.classList.add('lock');
    }else{
      zone.classList.add('dz-bad'); zone.classList.remove('dz-ok');
      tok.classList.remove('lock');
    }
    checkMatch1();
  }
  function checkMatch1(){
    const zones = $$('#match .dropzone');
    const allOk = zones.every(z=> z.classList.contains('dz-ok'));
    const anyBad = zones.some(z=> z.classList.contains('dz-bad'));
    $('#match1Msg').textContent = allOk ? '✅ ¡Correcto! Términos emparejados.' : (anyBad ? '❌ Hay definiciones en lugares incorrectos.' : 'Arrastra definiciones a cada término.');
    if(allOk){ state.done.act1 = true; store('anupro360_m2_1', state); calcProgress(); }
  }
  $('#resetMatch1')?.addEventListener('click', ()=>{
    $$('#match .dropzone').forEach(z=>{ z.classList.remove('dz-ok','dz-bad'); const t=z.querySelector('.token'); if(t){ t.classList.remove('lock'); $('#bank1').appendChild(t);} });
    $('#match1Msg').textContent=''; state.done.act1=false; store('anupro360_m2_1', state); calcProgress();
  });
  ddSetup('#match');

  /* ---------- Actividad 2: Ordenar pasos ---------- */
  let dragItem=null;
  $$('#orden .item').forEach(it=>{
    it.addEventListener('dragstart', ()=>{ dragItem=it; it.classList.add('ghost'); });
    it.addEventListener('dragend', ()=>{ dragItem=null; it.classList.remove('ghost'); });
  });
  $('#orden')?.addEventListener('dragover', e=>{
    e.preventDefault();
    const after = getDragAfterElement($('#orden'), e.clientY);
    if(after==null){ $('#orden').appendChild(dragItem); }
    else{ $('#orden').insertBefore(dragItem, after); }
  });
  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.item:not(.ghost)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset<0 && offset>closest.offset){ return {offset, element:child}; }
      else return closest;
    }, {offset:Number.NEGATIVE_INFINITY}).element;
  }
  const ordenCorrecto = ['charla','verificar','ejecutar','registro','cierre'];
  $('#checkOrden')?.addEventListener('click', ()=>{
    const ids = $$('#orden .item').map(i=>i.dataset.id);
    let ok=0;
    $$('#orden .item').forEach((i,idx)=>{
      if(ordenCorrecto[idx]===i.dataset.id){ i.classList.add('ok'); ok++; } else { i.classList.remove('ok'); }
    });
    if(ok===ordenCorrecto.length){
      $('#ordenMsg').textContent='✅ Orden correcto. Excelente práctica.';
      state.done.act2=true; store('anupro360_m2_1', state); calcProgress();
    }else{
      $('#ordenMsg').textContent=`❌ Hay ${ordenCorrecto.length-ok} elemento(s) fuera de lugar. Ajusta y vuelve a comprobar.`;
    }
  });
  $('#resetOrden')?.addEventListener('click', ()=>{
    const items = $$('#orden .item');
    items.forEach(i=> i.classList.remove('ok'));
    // reordenar aleatoriamente
    items.sort(()=>Math.random()-0.5).forEach(i=> $('#orden').appendChild(i));
    $('#ordenMsg').textContent='';
    state.done.act2=false; store('anupro360_m2_1', state); calcProgress();
  });

  /* ---------- Actividad 3: Escenarios ---------- */
  function ddSetup2(){
    let dragging=null;
    $$('#bank2 .token').forEach(tok=>{
      tok.addEventListener('dragstart', ()=>{ dragging=tok; tok.classList.add('dragging'); });
      tok.addEventListener('dragend', ()=>{ dragging=null; tok.classList.remove('dragging'); });
      tok.addEventListener('click', ()=>{
        const target = document.activeDropzone2 || null;
        if(target) tryDrop2(target, tok);
      });
    });
    $$('#esc .dropzone, #esc .bank').forEach(zone=>{
      zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('drop'); document.activeDropzone2 = zone; });
      zone.addEventListener('dragleave', ()=> zone.classList.remove('drop'));
      zone.addEventListener('drop', (e)=>{ e.preventDefault(); zone.classList.remove('drop'); if(dragging) tryDrop2(zone, dragging); });
      zone.addEventListener('click', ()=>{ document.activeDropzone2 = zone; });
    });
  }
  function tryDrop2(zone, tok){
    if(zone.classList.contains('bank')){ tok.classList.remove('lock'); zone.appendChild(tok); zone.classList.remove('dz-ok','dz-bad'); return; }
    const accept = zone.dataset.accept;
    const key = tok.dataset.key;
    const prev = zone.querySelector('.token'); if(prev){ $('#bank2').appendChild(prev); prev.classList.remove('lock'); }
    zone.appendChild(tok);
    if(accept===key){ zone.classList.add('dz-ok'); zone.classList.remove('dz-bad'); tok.classList.add('lock'); }
    else{ zone.classList.add('dz-bad'); zone.classList.remove('dz-ok'); tok.classList.remove('lock'); }
    checkMatch2();
  }
  function checkMatch2(){
    const zones = $$('#esc .dropzone');
    const allOk = zones.every(z=> z.classList.contains('dz-ok'));
    const anyBad = zones.some(z=> z.classList.contains('dz-bad'));
    $('#match2Msg').textContent = allOk ? '✅ Escenarios resueltos correctamente.' : (anyBad ? '❌ Revisa las coincidencias.' : 'Asigna cada escenario a su acción.');
    if(allOk){ state.done.act3 = true; store('anupro360_m2_1', state); calcProgress(); }
  }
  $('#resetMatch2')?.addEventListener('click', ()=>{
    $$('#esc .dropzone').forEach(z=>{ z.classList.remove('dz-ok','dz-bad'); const t=z.querySelector('.token'); if(t){ t.classList.remove('lock'); $('#bank2').appendChild(t);} });
    $('#match2Msg').textContent='';
    state.done.act3=false; store('anupro360_m2_1', state); calcProgress();
  });
  ddSetup2();

  /* ---------- Checklist ---------- */
  $$('.ck').forEach(c=> c.addEventListener('change', ()=>{
    const all = $$('.ck').every(x=>x.checked);
    if(all){ $('#ckMsg').textContent='✅ Checklist completado.'; state.done.check=true; store('anupro360_m2_1', state); calcProgress(); }
    else { $('#ckMsg').textContent='Marca las tres casillas para completar.'; state.done.check=false; store('anupro360_m2_1', state); calcProgress(); }
  }));

  /* ---------- Quiz 10 preguntas ---------- */
  const preguntas=[
    {q:'Tu primera acción ante una tarea insegura es…', opts:['Apurarla para terminar antes','Detenerla y replantear','Registrar al final'], ok:1},
    {q:'Un control crítico es…', opts:['Cualquier EPP','Una barrera clave frente a eventos graves','Un letrero llamativo'], ok:1},
    {q:'Liderazgo visible significa…', opts:['Mandar más','Estar en terreno, escuchar, verificar y reforzar seguridad','Hacer más reportes'], ok:1},
    {q:'La Ley 16.744 se relaciona con…', opts:['Auditorías contables','Accidentes y enfermedades profesionales y su prevención','Diseño de rutas logísticas'], ok:1},
    {q:'La charla de 5’ incluye principalmente…', opts:['Tres anécdotas del día','Un riesgo crítico, un control y una conducta esperada','Revisión de sueldos'], ok:1},
    {q:'Si un control crítico no está presente, corresponde…', opts:['Entregar más EPP y seguir','Detener y replantear','Pedir fotos y continuar'], ok:1},
    {q:'La bitácora debe contener…', opts:['Plan, ejecución, hallazgos/cierres','Chistes de turno','Solo firmas'], ok:0},
    {q:'“Probabilidad x consecuencia” define…', opts:['Peligro','Riesgo','Procedimiento'], ok:1},
    {q:'¿Qué pilar del rol implica organizar, comunicar y verificar?', opts:['Modelo','Gestor','Protector'], ok:1},
    {q:'Una lección aprendida útil debe…', opts:['Culpar al responsable','Detallar causa y cambio concreto','Pedir más formularios'], ok:1},
  ];
  function renderQuiz(){
    const wrap=$('#quiz'); wrap.innerHTML='';
    preguntas.forEach((p,i)=>{
      const div=document.createElement('div');
      div.className='q'; div.dataset.index=i; div.dataset.ok=p.ok;
      div.innerHTML=`<div style="font-weight:700">${i+1}. ${p.q}</div>`;
      p.opts.forEach((txt,j)=>{
        const lab=document.createElement('label');
        lab.className='opt';
        lab.innerHTML=`<input type="radio" name="q${i}" value="${j}"><span>${txt}</span>`;
        div.appendChild(lab);
      });
      wrap.appendChild(div);
    });
  }
  function lockQuizAndColor(){
    const blocks = $$('#quiz .q');
    let okCount=0, wrongCount=0, unanswered=0;
    blocks.forEach((div)=>{
      const ok = Number(div.dataset.ok);
      const sel = div.querySelector('input[type="radio"]:checked');
      div.querySelectorAll('input').forEach(inp=> inp.disabled=true);
      const correctLabel = div.querySelector(`input[value="${ok}"]`)?.closest('label');
      correctLabel?.classList.add('correct');
      if(!sel){ div.classList.add('wrong'); unanswered++; wrongCount++; return; }
      const chosen = Number(sel.value);
      if(chosen===ok){ div.classList.add('correct'); okCount++; }
      else { div.classList.add('wrong'); sel.closest('label')?.classList.add('wrong'); wrongCount++; }
    });
    const total = preguntas.length;
    const pct = Math.round(okCount/total*100);
    $('#quizFeedback').textContent = `Resultado: ${okCount}/${total} (${pct}%). ✅ Correctas en verde · ❌ Incorrectas en rojo${unanswered?` · ${unanswered} sin responder`:''}.`;
  }
  function resetQuizColors(){
    $$('#quiz .q').forEach(div=>{
      div.classList.remove('correct','wrong');
      div.querySelectorAll('label').forEach(l=> l.classList.remove('correct','wrong'));
      div.querySelectorAll('input').forEach(inp=>{ inp.disabled=false; inp.checked=false; });
    });
    $('#quizFeedback').textContent='';
  }
  $('#enviar').addEventListener('click', ()=>{ lockQuizAndColor(); state.done.quiz=true; store('anupro360_m2_1', state); calcProgress(); });
  $('#resetQuiz').addEventListener('click', ()=>{ resetQuizColors(); state.done.quiz=false; store('anupro360_m2_1', state); calcProgress(); });

  /* Reflexión */
  const ref = $('#reflexion'); ref.value = state.reflexion||'';
  $('#guardarRef').addEventListener('click', ()=>{ state.reflexion = (ref.value||'').trim(); store('anupro360_m2_1', state); alert('Reflexión guardada en este dispositivo.'); });
  $('#copiarRef').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText((ref.value||'').trim()); alert('Texto copiado. Pégalo en Classroom.'); }catch(e){ alert('No se pudo copiar automáticamente. Copia manualmente.'); } });

  /* Init */
  renderQuiz(); calcProgress(); $('#year').textContent = new Date().getFullYear();
</script>
</body>
</html>
